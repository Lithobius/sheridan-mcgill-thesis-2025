---
title: "Range comparison"
author: "Kate Sheridan"
date: "`r Sys.Date()`"
output: html_document
---

Comparison of eDNA to literature

This script contains the overlap plots that calculate the difference between the highest and lowest latitude of each as well as prevalence plots that map overlap to different metrics of detectability. 


```{r setup, include=FALSE}
library(tidyverse)
library(here)
library(ggpubr)

# here filepath
bigdata <- here('processeddata','bigdata')
dataedna <- here('processeddata', 'peco', '2021-24_edna')
# save in
ranges <- here::here("output", "rangecomparison")

datefield <- '20250927_'

# version of palette to extract values from
pal<-  PNWColors::pnw_palette("Bay", 15, type = "continuous") 
# palette
pal_2or <- c("Juneau Region, Alaska" = "#00496F",
             "Southeast Alaska" = "#03587B",
             "Haida Gwaii, British Columbia" = "#076787",
             "Central Coast British Columbia" = "#0B7693",
             "North Vancouver Island, British Columbia" = "#0F85A0",
             "Inner Coast, British Columbia" = "#469989",
             "Pacific Rim Park, British Columbia" = "#7EAE73",
             "Puget Sound & Padilla Bay, Washington" = "#B5C25C",
             "Willapa Bay, Washington" = "#EDD746",
             "Yaquina Bay, Oregon" = "#EDC334",
             "Coos Bay, Oregon" = "#EDB123",
             "Humboldt Bay, California" = "#ED9E11",
             "Bodega Bay, California" = "#ED8B00",
             "San Fransisco Bay, California" = "#E97809",
             "Morro Bay, California" = "#E56512",
             "Los Angeles, California" = "#E1531B",
             "San Diego region, California" = "#DD4124")
```

```{r load-in}
regions <- read_csv(here(dataedna, '20251107_peco_region-name-plotting.csv'))[-1] %>%
  rename(region_label = region_name_label)

region_order <- regions %>%
  select(region_lat_name, region_name, region_label, avg_region_lat) %>% 
  distinct() %>%
  arrange(-avg_region_lat)

site_order <- regions %>%
  select(site_code, decimal_latitude) %>%
  arrange(decimal_latitude)

# edna
mifish_edna <- read_csv(here(dataedna,
                             '20251107_peco-combined_12s_asvmatrix_fish.csv'))[-1]%>%
  filter(rank == 'species') %>%
    filter(relabund_vst_taxa > 3) %>%
  rename(region_label = region_name_label) %>%
  filter(!(sample_id %in% c('pecoe-0207'))) %>%
    # fish with no records
  filter(!(found_taxa %in% c(#'Alosa sapidissima', 
                             'Tautogolabrus adspersus',
                             'Squalius cephalus',
                             # freshwater
                             'Barbatula barbatula', 'Gobio gobio',
                             'Gambusia affinis', 'Rhinichthys cataractae'#,
                             # makes inf in model?
                             #'Spirinchus starksi',
                             #'Cynoscion parvipinnis'
                             ))) #%>%
  # species-genus-family for ? might not need this anymore
  #mutate(sgf = paste0(found_taxa, '-', genus, '-', family))

edna_fish_range <- mifish_edna %>%
  select(found_taxa, common_name, taxa_max, taxa_min, taxa_median) %>%
  distinct() %>%
  rename(edna_max = taxa_max,
         edna_min = taxa_min,
         edna_median = taxa_median) %>%
  rename(species = found_taxa)

# set an order for plotting; here mean of range found
fish_order <- mifish_edna %>%
  select(found_taxa, common_name, taxa_median) %>%
  distinct() %>%
  arrange(taxa_median) 

# literature
fish_lit <- read_csv(here('rawdata', 'peco', '20250626_range-from-literature.csv')) %>%
  rename(lit_max = max_lat,
         lit_min = min_lat,
         species = found_taxa) %>%
  select(!c(min_long, max_long)) 

# habitat
fish_seagrass <- read_csv(here('processeddata', 'traits', '20250626_fish_seagrass-traits.csv')) %>%
  select(species, seagrass_yes, seagrass_maybe) %>%
  mutate(seagrass_yes = ifelse(seagrass_yes %in% c('x'), 'yes', NA_character_)) %>%
  mutate(seagrass_maybe = ifelse(seagrass_maybe %in% c('x'), 'maybe', "unknown")) %>%
  mutate(seagrass = coalesce(seagrass_yes, seagrass_maybe))

```

```{r summary stats}
# ranges for all three methods
all_range <- edna_fish_range %>%
  left_join(fish_lit) %>%
  # complicated to get around NAs for now
  mutate(farther_north = ifelse(lit_max >= 60, 'north', 'not')) %>%
  mutate(farther_south = ifelse(lit_min <= 31.5, 'south', 'xnot'))%>%
  mutate(lit_max = ifelse(lit_max >= 60, 60, lit_max)) %>%
  mutate(lit_min = ifelse(lit_min <= 31.5, 31.5, lit_min)) %>%
    # absolute min, max, range (what is 100%)
  mutate(abs_max_type = case_when(edna_max >= lit_max ~ 'edna',
                                    is.na(lit_max) ~ 'unknown',
                                  lit_max >= edna_max~ 'lit')) %>%
    mutate(abs_min_type = case_when(edna_min <= lit_min ~ 'edna',
                                    is.na(lit_min) ~ 'unknown',
                                  lit_min <= edna_min  ~ 'lit')) %>%
  mutate(abs_max = case_when(abs_max_type == 'edna' ~ edna_max,
                             abs_max_type == 'lit' ~ lit_max)) %>%
  mutate(abs_min = case_when(abs_min_type == 'edna' ~ edna_min,
                             abs_min_type == 'lit' ~ lit_min)) %>%
    mutate(edna_span = edna_max - edna_min,
         lit_span = lit_max - lit_min) %>%
  mutate(lit_edge_s = ifelse(lit_min < 32.8, 'yes', 'no'),
         lit_edge_n = ifelse(lit_max > 58.5, 'yes', 'no')) %>%
  left_join(fish_seagrass) %>%
  filter(!is.na(lit_max))

# offset
range_offset <- all_range %>%
  # latitude of obis/gbif compared to eDNA
  # positive = higher, negative = lower
  mutate(edna_lit_n = lit_max - edna_max) %>%
  mutate(edna_lit_s = lit_min - edna_min) %>%
  relocate(edna_lit_n, edna_lit_s, .before = edna_max)


samplesite <- mifish_edna %>% 
  select(sample_id, year, site_code) %>%
  distinct() %>%
  left_join(regions) %>%
  select(!c(samples, sites)) %>%
  # calculate how many samples per site
  # by year and total
  group_by(year) %>%
  add_count(site_code, name = 'n_samplesite_year') %>%
  ungroup() %>%
  relocate(n_samplesite_year, .before = region_code) 


prevalence_sp <- mifish_edna %>%
  filter(rank == 'species') %>%
  select(sample_id, site_code, year, found_taxa, common_name,
         relabund_vst_taxa) %>%
  distinct() %>%
  # how many sites was it found in that year?
  add_count(found_taxa, site_code, year, name='n_spsite_year') %>%
  left_join(samplesite) %>%
  mutate(prev_year = n_spsite_year / n_samplesite_year) %>%
  relocate(prev_year, 
           .before = found_taxa) %>%
  # we'll measure means of prevalance by year across sites
  # and mean relative abundance
  select(found_taxa, common_name, prev_year,
         relabund_vst_taxa) %>%
  group_by(found_taxa) %>%
  mutate(mean_prev_year = mean(prev_year)) %>%
  mutate(mean_relabund = mean(relabund_vst_taxa)) %>%
  ungroup() %>%
  select(found_taxa, common_name, mean_prev_year, mean_relabund) %>%
  distinct() %>%
  left_join(range_offset) %>%
  filter(!is.na(lit_max)) %>%
  left_join(fish_seagrass)%>%
  mutate(seagrass = ifelse(is.na(seagrass), 'unknown', seagrass))

# csv output for table
prev_sp_csv <- prevalence_sp %>%
  select(found_taxa, common_name, mean_prev_year, 
         edna_lit_n, edna_lit_s, farther_north, farther_south) %>%
  # round digits
  mutate(mean_prev_year = round(mean_prev_year, digits = 4),
         edna_lit_n = round(edna_lit_n, digits = 4),
         edna_lit_s = round(edna_lit_s, digits = 4)) %>%
  distinct() %>%
  # collapse domain columns
  mutate(Extends_past_domain = case_when(farther_north == 'north' & farther_south == 'south' ~ 'Both',
                             farther_north == 'north' & farther_south == 'xnot' ~ 'North',
                             farther_north == 'not' & farther_south == 'south' ~ 'South',
                             farther_north == 'not' & farther_south == 'xnot' ~ 'No')) %>%
  select(!c(farther_north, farther_south)) %>%
  arrange(found_taxa) %>%
  # simplify for later
  rename(Species = found_taxa,
         Mean_prevalence = mean_prev_year,
         Northern_offset = edna_lit_n,
         Southern_offset = edna_lit_s)

# offset stats for table
write_csv(prev_sp_csv, here(ranges,
                            paste0(datefield, 'offset_literature.csv')))
```



```{r figure version}
ggplot(prevalence_sp) +
  geom_point(aes(y = edna_lit_n, 
                 x = mean_prev_year,
                  colour = as.factor(farther_north)),
             size = 2) +
      scale_colour_manual(values = c("grey80", "black")) +
  geom_smooth(method = lm, 
              colour = 'grey50',
              aes(y = edna_lit_n, x = mean_prev_year)) +
  geom_hline(yintercept = 0) +
  scale_y_continuous(limits = c(-30,30)) +
  labs(y = NULL,
       x = NULL,
       title = 'North') +
  theme_bw() +
  theme(axis.text = element_text(size = 20),
        axis.title.y = element_text(size = 18),
        title = element_text(size = 20),
        legend.position = 'none')

ggsave(filename = here(ranges, 
                       paste0(datefield,
                              'lit-offset-prevalence_domain_n_figvers.pdf')),
       height = 5,
       width = 8,
       units = 'in')

ggplot(prevalence_sp) +
  geom_point(aes(y = edna_lit_s, 
                 x = mean_prev_year,
                  colour = as.factor(farther_south)),
             
             size = 2) +
      scale_color_manual(values = c("grey80", "black"))+
  geom_hline(yintercept = 0) +
  geom_smooth(method = lm, 
              colour = 'grey50',
              aes(y = edna_lit_s, x = mean_prev_year)) +
  scale_y_continuous(limits = c(-30,30)) +
  labs(y = "Degrees latitude difference between Literature & eDNA",
       x = NULL,
       title = 'South') +
  theme_bw() +
  theme(axis.text = element_text(size = 20),
        axis.title.y = element_text(size = 18),
        title = element_text(size = 20),
        legend.position = 'none')


ggsave(filename = here(ranges, paste0(datefield,
                                                  'lit-offset-prevalence_domain_s_figvers.pdf')),
       height = 5,
       width = 8,
       units = 'in')


# domain separate

ggplot(prevalence_sp) +
  geom_point(aes(y = edna_lit_n, 
                 x = mean_prev_year),
             colour = 'black',
             size = 2) +
  facet_grid(~ farther_north) +
  geom_smooth(method = lm, 
              colour = 'grey50',
              aes(y = edna_lit_n, x = mean_prev_year)) +
  geom_hline(yintercept = 0) +
  scale_y_continuous(limits = c(-30,30)) +
  labs(y = NULL,
       x = NULL,
       title = 'North') +
  theme_bw() +
  theme(axis.text = element_text(size = 20),
        axis.title.y = element_text(size = 18),
        title = element_text(size = 20),
        legend.position = 'none')

ggsave(filename = here(ranges, paste0(datefield, 'lit-offset-prevalence_north-separate-figureversion.png')),
       height = 1000,
       width = 2500,
       units = 'px')

ggsave(filename = here(ranges, paste0(datefield, 'lit-offset-prevalence_north-separate-figureversion.pdf')),
       height = 5,
       width = 7,
       units = 'in')

ggplot(prevalence_sp) +
  geom_point(aes(y = edna_lit_s, 
                 x = mean_prev_year),
             colour = 'black',
             size = 2) +
  geom_hline(yintercept = 0) +
  scale_y_continuous(limits = c(-30,30)) +
  facet_grid(~ farther_south) +
  geom_smooth(method = lm, 
              colour = 'grey50',
              aes(y = edna_lit_s, x = mean_prev_year)) +
  labs(y = NULL,
       x = NULL,
       title = 'South') +
  theme_bw() +
  theme(axis.text = element_text(size = 20),
        axis.title.y = element_text(size = 18),
        title = element_text(size = 20),
        legend.title = element_blank(),
        legend.position = 'none')


ggsave(filename = here(ranges, paste0(datefield, 'lit-offset-prevalence_south-separate-figureversion.png')),
       height = 1000,
       width = 2500,
       units = 'px')

ggsave(filename = here(ranges, paste0(datefield, 'lit-offset-prevalence_south-separate-figureversion.pdf')),
       height = 5,
       width = 7,
       units = 'in')


# VST
vst_n <- ggplot(prevalence_sp) +
  geom_point(aes(y = edna_lit_n, x = mean_relabund),
             colour = 'black',
             size = 2) +
  geom_hline(yintercept = 0) +
  scale_y_continuous(limits = c(-30,30)) +
  geom_smooth(method = lm, 
              colour = 'grey50',
              aes(y = edna_lit_n, x = mean_relabund)) +
  labs(
       x = NULL,
       y = NULL,
       title = 'North') +
  theme_bw()+
  theme(axis.text = element_text(size = 20),
        axis.title.y = element_text(size = 18),
        title = element_text(size = 20))

vst_s <- ggplot(prevalence_sp) +
  geom_point(aes(y = edna_lit_s, x = mean_relabund),
             colour = 'black',
             size = 2) +
  geom_hline(yintercept = 0) +
  geom_smooth(method = lm, colour = 'grey50',
              aes(y = edna_lit_s, x = mean_relabund)) +
  scale_y_continuous(limits = c(-30,30)) +
  labs(y = NULL,
       x = NULL,
       title = 'South') +
  theme_bw() +
  theme(axis.text = element_text(size = 20),
        axis.title.y = element_text(size = 18),
        title = element_text(size = 20))

vst_both <- ggarrange(vst_n, vst_s)%>%
  annotate_figure(
                  bottom = text_grob('Mean VST abundance', size = 20)) + 
  bgcolor('white')


vst_both

ggsave(vst_both, filename = here(ranges, paste0(datefield, 'lit-offset-vst_figvers.png')),
       height = 1000,
       width = 2500,
       units = 'px')

ggsave(vst_both, filename = here(ranges, paste0(datefield, 'lit-offset-vst_figvers.pdf')),
       height = 9,
       width = 18,
       units = 'in')


# habitat figure version

## prevalence seagrass
prev_n2 <- ggplot(prevalence_sp) +
  geom_point(aes(y = edna_lit_n, 
                 x = mean_prev_year,
                  alpha = as.factor(seagrass),
                 shape = as.factor(seagrass)),
             colour = 'black',
             size = 2) +
      scale_alpha_manual(values = c(.5, .1, 1),
                     labels = c('Association with habitats near eelgrass', 
                                'Unknown', 'Associated with eelgrass')
                     ) +
          scale_shape_manual(values = c(16, 16, 17),
                     labels = c('Association with habitats near eelgrass', 
                                'Unknown', 'Associated with eelgrass')
                     )+
  geom_smooth(method = lm, 
              colour = 'grey50',
              aes(y = edna_lit_n, x = mean_prev_year)) +
  geom_hline(yintercept = 0) +
  scale_y_continuous(limits = c(-30,30)) +
  labs(y = NULL,
       x = NULL,
       title = 'North') +
  theme_bw() +
  theme(axis.text = element_text(size = 20),
        axis.title.y = element_text(size = 18),
        title = element_text(size = 20))

prev_s2 <- ggplot(prevalence_sp) +
  geom_point(aes(y = edna_lit_s, 
                 x = mean_prev_year,
                  shape = as.factor(seagrass),
                 alpha = as.factor(seagrass)),
             colour = 'black',
             size = 2) +
      scale_alpha_manual(values = c(.5, .1, 1),
                     labels = c('Association with habitats near eelgrass', 
                                'Unknown', 'Associated with eelgrass')
                     )+
        scale_shape_manual(values = c(16, 16, 17),
                     labels = c('Association with habitats near eelgrass', 
                                'Unknown', 'Associated with eelgrass')
                     )+
  geom_hline(yintercept = 0) +
  scale_y_continuous(limits = c(-30,30)) +
  geom_smooth(method = lm, 
              colour = 'grey50',
              aes(y = edna_lit_s, x = mean_prev_year)) +
  labs(y = NULL,
       x = NULL,
       title = 'South') +
  theme_bw() +
  theme(axis.text = element_text(size = 20),
        axis.title.y = element_text(size = 14),
        title = element_text(size = 20),
        legend.title = element_blank())



prev_both2 <- ggarrange(prev_n2, prev_s2, common.legend = TRUE) %>%
  annotate_figure(
                  bottom = text_grob('Mean yearly prevalence', size = 20)) + 
  bgcolor('white')

ggsave(prev_both2, filename = here(ranges, paste0(datefield, 'lit-offset-prevalence_seagrass_figvers.pdf')),
       height = 6,
       width = 12,
       units = 'in')

prev_both2

```


# Models
LM 
```{r models}
seagrass_n_lm <- lm(edna_lit_n ~ mean_prev_year + relevel(as.factor(seagrass), ref = 'yes'), 
                    data = prevalence_sp)

summary(seagrass_n_lm)
hist(seagrass_n_lm$residuals)
qqnorm(seagrass_n_lm$residuals)
qqline(seagrass_n_lm$residuals)

seagrass_s_lm <- lm(edna_lit_s ~ mean_prev_year + relevel(as.factor(seagrass), ref = 'yes'), 
                    data = prevalence_sp)

summary(seagrass_s_lm)
hist(seagrass_s_lm$residuals)
qqnorm(seagrass_s_lm$residuals)
qqline(seagrass_s_lm$residuals)

glimpse(prevalence_sp)

seagrass_s_lm2 <- lm(edna_lit_s ~ relevel(as.factor(seagrass), ref = 'yes'), 
                    data = prevalence_sp)
summary(seagrass_s_lm2)


ggplot(prevalence_sp) +
  geom_boxplot(aes(x = as.factor(seagrass), 
                   y = edna_lit_s)) +
  theme_bw()


ggplot(prevalence_sp) +
  geom_violin(aes(x = as.factor(seagrass), 
                   y = edna_lit_s)) +
      theme_bw() +
  theme(axis.text = element_text(size = 20),
        axis.title.y = element_text(size = 18),
        title = element_text(size = 20))

ggsave(here(ranges, paste0(datefield, 'eelgrass_violin_s.png')),
       width = 1250,
       height = 1500,
       units = 'px')

# seagrass only
seagrass_n_lm2 <- lm(edna_lit_n ~ relevel(as.factor(seagrass), ref = 'yes'), 
                    data = prevalence_sp)
summary(seagrass_n_lm2)


ggplot(prevalence_sp) +
  geom_boxplot(aes(x = as.factor(seagrass), 
                   y = edna_lit_n)) +
  theme_bw()


ggplot(prevalence_sp) +
  geom_violin(aes(x = as.factor(seagrass), 
                   y = edna_lit_n)) +
    theme_bw() +
  theme(axis.text = element_text(size = 20),
        axis.title.y = element_text(size = 18),
        title = element_text(size = 20))

ggsave(here(ranges, paste0(datefield, 'eelgrass_violin_n.png')),
       width = 1250,
       height = 1500,
       units = 'px')
```

## Domain edge separate

```{r domain separate}
prevalence_sp_n_edge <- prevalence_sp %>%
  filter(farther_north == 'north')

prevalence_sp_n_within <- prevalence_sp %>%
  filter(farther_north == 'not')

prevalence_sp_s_edge <- prevalence_sp %>%
  filter(farther_south == 'south')

prevalence_sp_s_within <- prevalence_sp %>%
  filter(farther_south == 'xnot')

seagrass_n_edge_lm <- lm(edna_lit_n ~ mean_prev_year + relevel(as.factor(seagrass), ref = 'yes'), 
                    data = prevalence_sp_n_edge)

summary(seagrass_n_edge_lm)
hist(seagrass_n_edge_lm$residuals)
qqnorm(seagrass_n_edge_lm$residuals)
qqline(seagrass_n_edge_lm$residuals)

seagrass_n_within_lm <- lm(edna_lit_n ~ mean_prev_year + relevel(as.factor(seagrass), ref = 'yes'), 
                    data = prevalence_sp_n_within)

summary(seagrass_n_within_lm)
hist(seagrass_n_within_lm$residuals)
qqnorm(seagrass_n_within_lm$residuals)
qqline(seagrass_n_within_lm$residuals)

seagrass_s_edge_lm <- lm(edna_lit_s ~ mean_prev_year + relevel(as.factor(seagrass), ref = 'yes'), 
                    data = prevalence_sp_s_edge)

summary(seagrass_s_edge_lm)
hist(seagrass_s_edge_lm$residuals)
qqnorm(seagrass_s_edge_lm$residuals)
qqline(seagrass_s_edge_lm$residuals)

seagrass_s_within_lm <- lm(edna_lit_s ~ mean_prev_year + relevel(as.factor(seagrass), ref = 'yes'), 
                    data = prevalence_sp_s_within)

summary(seagrass_s_within_lm)
hist(seagrass_s_within_lm$residuals)
qqnorm(seagrass_s_within_lm$residuals)
qqline(seagrass_s_within_lm$residuals)


```

## poisson

```{r}
north_poisson <- prevalence_sp %>%
  filter(farther_north == 'north') %>%
  mutate(edna_lit_n = ifelse(edna_max == max(edna_max) & lit_max == 60,0, edna_lit_n))
south_poisson <- prevalence_sp %>%
  filter(farther_south == 'south')%>%
  mutate(edna_lit_s = ifelse(edna_min == max(edna_min) & lit_min == 32,0, edna_lit_s))

prevalence_n_poisson <- glm(edna_lit_n ~ mean_prev_year,
                            family = "poisson",
                            data = north_poisson)

summary(prevalence_n_poisson)
hist(prevalence_n_poisson$residuals)
qqnorm(prevalence_n_poisson$residuals)
qqline(prevalence_n_poisson$residuals)

plot(prevalence_n_poisson)


prevalence_s_poisson <- glm(abs(edna_lit_s) ~ mean_prev_year,
                            family = "poisson",
                            data = south_poisson)

summary(prevalence_s_poisson)
hist(prevalence_s_poisson$residuals)
qqnorm(prevalence_s_poisson$residuals)
qqline(prevalence_s_poisson$residuals)

plot(prevalence_s_poisson)
```



# range edges
put these alongside figure 5
```{r}
rangehist_data <- all_range %>%
  dplyr::select(species, common_name, lit_min, lit_max) %>%
  pivot_longer(cols = c(lit_min, lit_max),
               names_to = 'type') %>%
  filter(value > 32 & value < 60) %>%
  distinct() %>%
  pivot_wider(names_from = 'type')

rangehist_data %>%
  dplyr::select(!lit_min) %>%
  filter(!is.na(lit_max)) %>%
  ggplot() +
  geom_histogram(aes(lit_max),
                 alpha = .7) +
  scale_x_continuous(limits = c(31.5,60))+
  scale_y_continuous(limits = c(0,15))+
  coord_flip() +
  labs(title = 'Cool range edge', y = '') +
  theme_bw() +
  theme(panel.grid = element_blank())

ggsave(here(ranges, paste0(datefield, 'cool-edge_hist.png')))

ggsave(here(ranges, paste0(datefield, 'cool-edge_hist.pdf')),
       height = 15, width = 4, units = 'in', 
       device = 'pdf')


rangehist_data %>%
  dplyr::select(!lit_max) %>%
  filter(!is.na(lit_min)) %>%
  ggplot() +
  geom_histogram(aes(lit_min),
                 alpha = .7) +
  coord_flip() +
  scale_x_continuous(limits = c(31.5,60))+
  scale_y_continuous(limits = c(0,15))+
  labs(title = 'Warm range edge', y = '')+
  theme_bw() +
  theme(panel.grid = element_blank())

ggsave(here(ranges, paste0(datefield, 'warm-edge_hist.png')))

ggsave(here(ranges, paste0(datefield, 'warm-edge_hist.pdf')),
       height = 15, width = 4, units = 'in', 
       device = 'pdf')
```

# prevalence vs habitat

```{r prev-habitat}
prevalence_sp %>%
  ggplot() +
  geom_point(aes(x = mean_prev_year,
                 y = found_taxa,
                 colour = seagrass)) +
  theme_bw()

prevalence_sp %>%
  ggplot() +
  geom_boxplot(aes(x = mean_prev_year,
                 y = seagrass,
                 colour = seagrass)) +
  theme_bw()

# make sure your variable is a factor for ANOVA
prevalence_sp <- prevalence_sp %>%
  mutate(seagrass = as.factor(seagrass))

# anova: is there a difference in means between groups?
seagrass_type_aov <- aov(mean_prev_year ~ seagrass, 
                    data = prevalence_sp)

summary(seagrass_type_aov)
report::report(seagrass_type_aov)

# tukey; which group?
library(multcomp)
seagrass_aov_posttest <- glht(seagrass_type_aov,
                                        linfct = mcp(seagrass = "Tukey"))

summary(seagrass_aov_posttest)
plot(seagrass_aov_posttest)


TukeyHSD(seagrass_type_aov)
plot(TukeyHSD(seagrass_type_aov))

#install.packages('ggstatsplot')

ggstatsplot::ggbetweenstats(data = prevalence_sp,
                            x = seagrass,
                            y = mean_prev_year,
                            type = 'parametric',
                            var.equal = TRUE,
                            plot.type = 'box',
                            pairwise.display = 'significant',
                            pairwise.comparisons = TRUE,
                            centrality.plotting = FALSE,
                            bf.message = FALSE) +
  labs(y = 'Mean prevalence per year',
       x = '') +
  theme_bw() +
  theme(legend.position = 'none',
        axis.text = element_text(size = 10))

ggsave(here(ranges, paste0(datefield, 'seagrass-anova.png')),
       height = 900,
       width = 900,
       units = 'px')


prevalence_sp %>%
  dplyr::select(found_taxa, common_name, seagrass) %>%
  distinct() %>%
  add_count(seagrass) %>%
  dplyr::select(seagrass, n) %>%
  distinct()
```

# Direct latitudinal comparisons

Bars for latitude, colored by source

## obisgbif

```{r loadin obis-gbif}
bigdat_fish <-  read_csv(here('processeddata', 'bigdata',
               '20250813_obis-gbif_region-peco-bysite_unfiltered.csv')) %>%
  # taxonomic revision
  mutate(scientific_name = case_when(scientific_name == 'Syngnathus leptorhynchus' ~ 'Syngnathus californiensis',
                                     scientific_name == 'Gasterosteus aculeatus aculeatus' ~ 'Gasterosteus aculeatus',
                                     scientific_name == 'Gasterosteus aculeatus williamsoni' ~ 'Gasterosteus aculeatus',
                                     scientific_name == 'Oncorhynchus clarkii clarkii' ~ 'Oncorhynchus clarkii',
                                     scientific_name == 'Clupea pallasii pallasii' ~ 'Clupea pallasii',
                                     TRUE ~ scientific_name)) %>%
  filter(summer == TRUE) %>%
  # do we still need this?
  mutate(sgf = paste0(scientific_name, '-', genus, '-', family))

bigdat_pecofish <- bigdat_fish %>%
  filter(species %in% fish_order$found_taxa) %>%
  left_join(fish_order, by = c('scientific_name' = 'found_taxa')) %>%
  dplyr::select(!(c(taxa_median, gbif_species, worms_aphiaid, rank))) %>%
  distinct()

bigdat_range <- bigdat_pecofish %>%
  #filter(year >= 1990) %>%
  group_by(species) %>%
  summarise(bd_max = max(decimal_latitude), bd_mean = mean(decimal_latitude),
            bd_median = median(decimal_latitude), bd_min = min(decimal_latitude))

bigdat_pecofish <- bigdat_pecofish %>%
  left_join(bigdat_range)

bigdat_range_pecoyears <- bigdat_pecofish %>%
  filter(year >= 2021) %>%
  group_by(species) %>%
  summarise(bd_max = max(decimal_latitude), bd_mean = mean(decimal_latitude),
            bd_median = median(decimal_latitude), bd_min = min(decimal_latitude))

bigdat_pecofish_pecoyears <- bigdat_pecofish %>%
  filter(year >= 2021) %>%
  left_join(bigdat_range_pecoyears)
```

```{r dfs for plotting}
edna_fish_range <- mifish_edna %>%
  dplyr::select(found_taxa, common_name, taxa_max, taxa_min, taxa_median) %>%
  distinct() %>%
  rename(edna_max = taxa_max,
         edna_min = taxa_min,
         edna_median = taxa_median) %>%
  rename(species = found_taxa)

bigdat_range <- bigdat_pecofish %>%
  dplyr::select(species, bd_max, bd_min, bd_median) %>%
  distinct() 

all_range <- edna_fish_range %>%
  left_join(bigdat_range) %>%
  mutate(bd_max = ifelse(bd_max >= 60, 60, bd_max)) %>%
  mutate(bd_min = ifelse(bd_min <= 32, 32, bd_min))


all_range_long <- edna_fish_range %>%
  left_join(bigdat_range) %>%
  distinct() %>%
  pivot_longer(cols = !c(species, common_name),
               names_to = 'stat')

# for bars
fish_order2 <- all_range %>%
  # absolute min, max, range (what is 100%)
  mutate(abs_max = ifelse(edna_max >= bd_max, edna_max, bd_max),
         abs_min = ifelse(edna_min <= bd_min, edna_min, bd_min),
         abs_range = abs_max - abs_min) %>%
  # how big is the range for each
  mutate(edna_span = edna_max - edna_min,
         bd_span = bd_max - bd_min) %>%
  # iNCREASE EDNA SPAN FOR THINGS WITH 0; ONE POINT
  mutate(edna_max = ifelse(edna_span < .01, edna_max + .1 ,edna_max)) %>%
  mutate(edna_min = ifelse(edna_span < .01, edna_min - .1 ,edna_min)) %>%
  mutate(edna_span = ifelse(edna_span < .01, .01, edna_span)) %>%
  # what percent of the range is each
  mutate(edna_percent = edna_span / abs_range,
         bd_percent = bd_span / abs_range) %>%
  mutate(overlap = edna_percent + bd_percent - 1) %>%
  # what amount of range, subtraction
  mutate(edna_sub = abs_range - edna_span,
         bd_sub = abs_range - bd_span) %>%
  mutate(overlap = bd_span + edna_span - abs_range) %>%
  mutate(overlap2 = case_when(is.na(overlap) ~ -.000001,
                              overlap > .9 ~ .9,
                              overlap > .8 & overlap < .9 ~ .8,
                              overlap > .7 & overlap < .8 ~ .7,
                              overlap > .6 & overlap < .7 ~ .6,
                              overlap > .5 & overlap < .6 ~ .5,
                              overlap > .4 & overlap < .3 ~ .4,
                              overlap > .3 & overlap < .4 ~ .3,
                              overlap > .2 & overlap < .3 ~ .2,
                              overlap > .1 & overlap < .2 ~ .1,
                              overlap > .00000001 & overlap < .1 ~ .05,
                              TRUE ~ overlap))
```


```{r obisgbif plots}

range_lines <- fish_order2 %>%
  arrange(overlap) %>%
  mutate(fishorder = factor(common_name, levels = common_name)) %>%
  ggplot(aes(x = fishorder)) +
  #set up eDNA
  geom_segment(aes(y = edna_max, yend = edna_min, 
                   xend = common_name, 
                   group = common_name),
               size = 7,
               alpha = .5,
               col = pal[1]) +
  # set up obis-gbif
  geom_segment(aes(y = bd_max, yend = bd_min, 
                   xend = common_name, 
                   group = common_name),
               size = 7,
               alpha = .4,
               col = pal[6],
               position = position_nudge(x = .25)) +
  geom_point(data = region_order, aes(x = Inf, 
                                      y = region_order$avg_region_lat,
                                      color = region_order$region_label),
             size = 5,
             shape = 8) +
  scale_color_manual(values = pal_2or)+
  labs(x = NULL, y = NULL) +
  scale_y_continuous(limits = c(31.5,60))+
  # a little extra space for the points marking the sampling sites
  scale_x_discrete(expand = c(0,1.5)) +
  coord_cartesian(clip = 'off') +
  theme_pubclean()+
  theme(panel.grid = element_blank(),
        axis.text.x = element_text(angle = 65, hjust = 1, size = 15),
        axis.text.y = element_text(size = 25),
        #axis.text.y = element_blank(),
        #axis.ticks.y = element_blank(),
        plot.margin = margin(2,1,1,3, "cm"),
        legend.position = 'none')

range_lines

ggsave(here(ranges, paste0(datefield, 'edna-bigdata_species-range-lines.pdf')), 
       height = 15, width = 33, units = 'in', 
       device = 'pdf')




# Presentation version

range_lines +
  theme(axis.text.x = element_blank(),
        axis.ticks.x = element_blank(),
        panel.grid.major.y = element_line(linetype = 'dashed', colour = 'grey45'))

ggsave(here(ranges, paste0(datefield, 'edna-bigdata_species-range-lines_presentation.pdf')), 
       height = 15, width = 33, units = 'in', 
       device = 'pdf')


# png version
range_lines +
  theme(axis.text.x = element_text(size = 16),
        axis.ticks.x = element_blank(),
        panel.grid.major.y = element_line(linetype = 'dashed', colour = 'grey45')
        )

ggsave(here(ranges, paste0(datefield, 'edna-bigdata_species-range-lines_with-species.png')), 
       height = 4500, width = 9500, units = 'px', 
       device = 'png')

# png version
range_lines +
  theme(axis.text.x = element_blank(),
        axis.ticks.x = element_blank(),
        panel.grid.major.y = element_line(linetype = 'dashed', colour = 'grey45'),
        axis.text.y = element_text(size = 60))

ggsave(here(ranges, '20250505_edna-bigdata_species-range-lines_presentation.png'), 
       height = 4500, width = 9000, units = 'px', 
       device = 'png')


fish_order2 %>%
  arrange(overlap2, abs_range) %>%
  dplyr::select(!c(overlap, abs_min, abs_max, abs_range,
            bd_median, edna_median, edna_span, bd_span,
            edna_percent, bd_percent)) %>%
  relocate(species, common_name, overlap2) %>%
  write_csv(here(ranges, paste0(datefield, 'edna-bigdata_species-overlap.csv')))
```


## literature

```{r literature latitude}
all_range_lit <- edna_fish_range %>%
  left_join(bigdat_range) %>%
  left_join(fish_lit) %>%
  mutate(bd_max = ifelse(bd_max >= 60, 60, bd_max)) %>%
  mutate(bd_min = ifelse(bd_min <= 32, 32, bd_min)) %>%
  mutate(lit_max = ifelse(lit_max >= 60, 60, lit_max)) %>%
  mutate(lit_min = ifelse(lit_min <= 32, 32, lit_min))


all_range_lit_long <- all_range_lit %>%
  left_join(bigdat_range) %>%
  left_join(fish_lit) %>%
  distinct() %>%
  pivot_longer(cols = !c(species, common_name),
               names_to = 'stat') %>%
  filter(!is.na(value))

# for bars
fish_order_lit <- all_range_lit %>%
  filter(!is.na(lit_min)) %>%
  # absolute min, max, range (what is 100%)
  mutate(abs_max_type = case_when(edna_max >= lit_max ~ 'edna',
                                    is.na(lit_max) ~ 'edna',
                                  lit_max >= edna_max  ~ 'lit')) %>%
    mutate(abs_min_type = case_when(edna_min <= lit_min ~ 'edna',
                                    is.na(lit_min) ~ 'edna',
                                  lit_min <= edna_min  ~ 'lit')) %>%
  mutate(abs_max = case_when(abs_max_type == 'edna' ~ edna_max,
                             abs_max_type == 'lit' ~ lit_max)) %>%
  mutate(abs_min = case_when(abs_min_type == 'edna' ~ edna_min,
                             abs_min_type == 'lit' ~ lit_min)) %>%
  # how big is the range for each
  mutate(edna_span = edna_max - edna_min,
         lit_span = lit_max - lit_min,
         abs_range = abs_max - abs_min) %>%
  # iNCREASE EDNA SPAN FOR THINGS WITH 0; ONE POINT
  mutate(edna_max = ifelse(edna_span < .01, edna_max + .1 ,edna_max)) %>%
  mutate(edna_min = ifelse(edna_span < .01, edna_min - .1 ,edna_min)) %>%
  mutate(edna_span = ifelse(edna_span < .01, .01, edna_span)) %>%
  mutate(abs_range = ifelse(abs_range == 0, .01, abs_range)) %>%
  # what percent of the range is each
  mutate(edna_percent = edna_span / abs_range,
         lit_percent = lit_span / abs_range) %>%
  mutate(overlap = edna_percent  - 1) %>%
  mutate(overlap2 = case_when(is.na(overlap) ~ -.000001,
                              overlap > .9 ~ .9,
                              overlap > .8 & overlap < .9 ~ .8,
                              overlap > .7 & overlap < .8 ~ .7,
                              overlap > .6 & overlap < .7 ~ .6,
                              overlap > .5 & overlap < .6 ~ .5,
                              overlap > .4 & overlap < .3 ~ .4,
                              overlap > .3 & overlap < .4 ~ .3,
                              overlap > .2 & overlap < .3 ~ .2,
                              overlap > .1 & overlap < .2 ~ .1,
                              overlap > .00000001 & overlap < .1 ~ .05,
                              TRUE ~ overlap))
```

```{r}
range_lines_lit <- fish_order_lit %>%
  arrange(overlap2, abs_range) %>%
  mutate(fishorder = factor(common_name, levels = common_name)) %>%
  ggplot(aes(x = fishorder)) +
  #set up eDNA
  geom_segment(aes(y = edna_max, yend = edna_min, 
                   xend = common_name, 
                   group = common_name),
               linewidth = 5,
               alpha = .5,
               col = pal[1]) +
  # from literature
  geom_segment(aes(y = lit_max, yend = lit_min, 
                   xend = common_name, 
                   group = common_name),
               linewidth = 5,
               alpha = .25,
               col = pal[5],
               position = position_nudge(x = .5)) +
  geom_point(data = region_order, aes(x = Inf, 
                                      y = region_order$avg_region_lat,
                                      color = region_order$region_label),
             size = 5,
             shape = 8) +
  scale_color_manual(values = pal_2or)+
  labs(x = NULL, y = NULL) +
  scale_y_continuous(limits = c(31.5,60))+
  # a little extra space for the points marking the sampling sites
  scale_x_discrete(expand = c(0,1.5)) +
  coord_cartesian(clip = 'off') +
  theme_pubclean()+
  theme(panel.grid = element_blank(),
        axis.text.x = element_text(angle = 65, hjust = 1, size = 15),
        axis.text.y = element_text(size = 25),
        plot.margin = margin(2,1,1,3, "cm"),
        legend.position = 'none')

range_lines_lit

ggsave(here(ranges, paste0(datefield, 'edna-literature_species-range-lines.pdf')), 
       height = 15, width = 49, units = 'in', 
       device = 'pdf')

# figure version

range_lines_litonly_fig <- fish_order_lit %>%
  arrange(overlap, abs_range) %>%
  mutate(fishorder = factor(common_name, levels = common_name)) %>%
  ggplot(aes(x = fishorder)) +
  #set up eDNA
  geom_segment(aes(y = edna_max, yend = edna_min, 
                   xend = common_name, 
                   group = common_name),
               linewidth = 1,
               alpha = .5,
               col = pal[1]) +
  # from literature
  geom_segment(aes(y = lit_max, yend = lit_min, 
                   xend = common_name, 
                   group = common_name),
               linewidth = 1,
               alpha = .25,
               col = pal[5],
               position = position_nudge(x = .5)) +
  geom_point(data = region_order, aes(x = Inf, 
                                      y = region_order$avg_region_lat,
                                      color = region_order$region_label),
             size = 5,
             shape = 8) +
  scale_color_manual(values = pal_2or)+
  labs(x = NULL, y = NULL) +
  scale_y_continuous(limits = c(31.5,60))+
  # a little extra space for the points marking the sampling sites
  scale_x_discrete(expand = c(0,1.5)) +
  coord_cartesian(clip = 'off') +
  theme_pubclean()+
  theme(panel.grid = element_blank(),
        axis.text.x = element_blank(),
        axis.ticks.x = element_blank(),
        axis.text.y = element_text(size = 25),
        legend.position = 'none')

range_lines_litonly_fig
ggsave(here(ranges, paste0(datefield, 'edna-literature_species-range-lines_figver.pdf')), 
       height = 5.5, width = 14, units = 'in', 
       device = 'pdf')

# png version
range_lines_lit +
  theme(axis.text.x = element_text(size = 16),
        axis.ticks.x = element_blank(),
        panel.grid.major.y = element_line(linetype = 'dashed', colour = 'grey45')
        )

ggsave(here(ranges, paste0(datefield, 'edna-literature_species-range-lines_with-species.png')), 
       height = 4500, width = 9500, units = 'px', 
       device = 'png')

```



# combined per-species plots



```{r by species loop}
prevalence_spyear <- mifish_edna %>%
  dplyr::select(sample_id, site_code, year, found_taxa, common_name) %>%
  distinct() %>%
  # how many sites was it found in that year?
  add_count(found_taxa, site_code, year, name='n_spsite_year') %>%
  left_join(samplesite) %>%
  mutate(prev_year = n_spsite_year / n_samplesite_year) %>%
  relocate(prev_year, 
           .before = found_taxa) %>%
  dplyr::select(prev_year, found_taxa, common_name, year, site_code) %>%
  distinct()

bubble_plot_data_sp <- mifish_edna %>%
  dplyr::select(found_taxa, common_name, year, region_name, site_code, 
         motu_pa, taxa_min, taxa_max, taxa_median) %>%
  distinct() %>%
  left_join(regions) %>%
  left_join(prevalence_spyear) %>%
  left_join(all_range_lit)

region_order2 <- region_order %>%
  arrange(avg_region_lat)

splist <- unique(bubble_plot_data_sp$common_name)

for(i in 1:length(splist)){
  target_sp <- splist[i]
  
  target_ranges <- bubble_plot_data_sp %>%
    filter(common_name == target_sp) %>%
    dplyr::select(bd_max, bd_min, lit_max, lit_min) %>%
    distinct()
  
  bubble_plot_data_sp %>%
  filter(common_name == target_sp) %>%
  group_by(region_name, year) %>%
  add_count() %>%
  ungroup %>%
  ggplot() +
    geom_point(aes(x = year, 
                 y = decimal_latitude,
                 alpha = prev_year
                 #size = n
                 ),
              col = pal[1]) +
    geom_segment(data = target_ranges,
                 aes(y = lit_max, yend = lit_min,
                   x = 2024.5),
               col = pal[5],
               alpha = .25) +
    geom_segment(data = target_ranges,
                 aes(y = bd_max, yend = bd_min,
                   x = 2024.75),
               col = pal[6]) +
  scale_x_continuous(limits = c(2021,2024.8)) +
  scale_y_continuous(limits = c(32,60)) +
  theme_bw() +
  labs(title = paste0(target_sp)) +
  theme(axis.text = element_text(size = 8),
        axis.title.y = element_blank(),
        axis.text.y = element_text(size = 8),
        axis.title.x = element_blank(),
        axis.ticks = element_blank(),
        axis.text.x = element_text(angle = 70, hjust = 1, size = 8),
        #plot.margin = unit(c(1,10,1,1), 'lines'),
        panel.grid = element_blank(),
        panel.grid.major.y = element_line(linetype = 'dashed', 
                                          colour = 'grey45'),
        legend.position = 'none',
        plot.title = element_text(size = 5))
  
  ggsave(filename = here(ranges, 'splevel', paste0(datefield, 'bubble_', target_sp, '.pdf')),
       device = 'pdf', height = 5, width = 2, units = 'in')
}
```

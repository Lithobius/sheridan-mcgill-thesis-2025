---
title: "ch2-pcoa"
author: "Kate Sheridan"
date: "`r Sys.Date()`"
output: html_document
---

PCoA with eDNA, OBIS/GBIF

```{r setup, include=FALSE}
library(tidyverse)
library(here)
library(ggConvexHull)
library(vegan)
library(recluster)
library(ggtree)
library(ape)

# filepaths for use with here
# eDNA
dataedna <- here('processeddata', 'peco', '2021-24_edna')
bigdata <- here('processeddata', 'bigdata')
# save in
pcoa_out <- here::here("output", "pcoa")

datefield <- '20251117_'

# from PNW colors, Bay
# or with 2 oregon regions
pal_2or <- c("Juneau Region, Alaska" = "#00496F",
             "Southeast Alaska" = "#03587B",
             "Haida Gwaii, British Columbia" = "#076787",
             "Central Coast British Columbia" = "#0B7693",
             "North Vancouver Island, British Columbia" = "#0F85A0",
             "Inner Coast, British Columbia" = "#469989",
             "Pacific Rim Park, British Columbia" = "#7EAE73",
             "Puget Sound & Padilla Bay, Washington" = "#B5C25C",
             "Willapa Bay, Washington" = "#EDD746",
             "Yaquina Bay, Oregon" = "#EDC334",
             "Coos Bay, Oregon" = "#EDB123",
             "Humboldt Bay, California" = "#ED9E11",
             "Bodega Bay, California" = "#ED8B00",
             "San Francisco Bay, California" = "#E97809",
             "Morro Bay, California" = "#E56512",
             "Los Angeles, California" = "#E1531B",
             "San Diego region, California" = "#DD4124")
```

```{r load-in}
obisgbif <- read_csv(here(bigdata,
               '20251113_obis-gbif_region-peco-bysite_unfiltered.csv')) %>%
    rename(region_label = region_name_label) 

mifish_edna <- read_csv(here(dataedna,
                             '20251113_peco-combined_12s_asvmatrix_fish.csv'))[-1] %>%
  distinct() %>%
  # remove below threshold
  filter(relabund_vst_taxa > 1) %>%
  rename(region_label = region_name_label) %>%
  filter(!(sample_id %in% c('pecoe-0207')))

fishlist <- mifish_edna %>%
  filter(rank == 'species') %>%
  select(found_taxa) %>%
  distinct() %>%
  rename(species = found_taxa)

regions <- read_csv(here(dataedna, '20251113_peco_region-name-plotting.csv'))[-1] %>%
  rename(region_label = region_name_label)

region_order <- regions %>%
  select(region_lat_name, region_name, region_label, avg_region_lat) %>% 
  distinct() %>%
  arrange(-avg_region_lat)

region_order2 <- regions %>%
  select(region_lat_name, region_name, region_label, avg_region_lat) %>% 
  distinct() %>%
  arrange(avg_region_lat)

site_order <- regions %>%
  dplyr::select(site_code, decimal_latitude) %>%
  arrange(decimal_latitude)
```


# PCoA by site

Using each site as a point, combine year data into that site.

## OBIS-GBIF matched

These are matched to MiFish species and PECO years

```{r by-site-obisgbif}
set.seed(20212022)

sitesp_all_pa <- obisgbif %>%
  filter(scientific_name %in% fishlist$species) %>%
  filter(year >= 2021 & year < 2025) %>%
  mutate(sp_pa = 1) %>%
  # combine sites data
  select(scientific_name, sp_pa, site_code) %>%
  distinct() %>%
  pivot_wider(id_cols = site_code,
              names_from = scientific_name, 
              values_from = sp_pa) %>%
  column_to_rownames('site_code') %>%
  # make binary
  mutate(across(.cols = everything(), ~replace(., is.na(.), 0)))

#distance matrix
obisgbif_mifish_jaccard <- as.matrix(vegdist(sitesp_all_pa, method = 'jaccard', binary = T))

#pcoa
obisgbif_mifish_pcoa <- pcoa(obisgbif_mifish_jaccard)
#vectors for plotting
obisgbif_mifish_pcoa_plot <- as.data.frame(obisgbif_mifish_pcoa$vectors) %>% 
  janitor::clean_names() %>%
  select(axis_1, axis_2) %>%
  rownames_to_column('site')


# basic clustering
## note most of these settings are default
# consensus tree of 100 trees
obisgbif_mifish_upgma <- recluster.cons(sitesp_all_pa, 
                              dist = 'jaccard', 
                              method = 'average',
                              tr = 100,
                              p = .5)

# write tree
ape::write.tree(obisgbif_mifish_upgma$cons, 
                here(pcoa_out, paste0(datefield, 'obisgbif-mifish_clusters-site.tre')))

# looking at cuts
# expldiss shows cluster attribution for each cut, 
## explained dissimilarity, and resulting clusters, so we can pick:
# pick cut that represents > 90% dissimilarity ($expl.div)
#NOTE: identical before and after polytomies
obisgbif_mifish_expldiss <- recluster.expl.diss(obisgbif_mifish_upgma$cons, 
                                                obisgbif_mifish_jaccard)
obisgbif_mifish_expldiss

# extracting group identities from matrix at chosen cut (column)
obisgbif_mifish_clusters <- obisgbif_mifish_expldiss$matrix[,15] %>%
  as.data.frame()

# prepare to plot
# combine cluster identities with PCoA axes and metadata
obisgbif_mifish_plot <- obisgbif_mifish_clusters %>%
  rename(cluster = '.') %>%
  rownames_to_column('site') %>%
  left_join(obisgbif_mifish_pcoa_plot) %>%
  left_join(obisgbif, by = c('site' = 'site_code')) %>%
  select(site, cluster, axis_1, axis_2) %>%
  distinct() %>%
  left_join(regions, by = c('site' = 'site_code')) %>%
  rename(site_code = site)

# plot with partners as hulls
ggplot(obisgbif_mifish_plot, aes(x = axis_1, y = axis_2)) +
  geom_convexhull(aes(fill = as.factor(region_label)),
                  alpha=0.4) +
  scale_fill_manual(values = pal_2or)+
  geom_point(aes(x = axis_1, y = axis_2, 
                 col = as.factor(region_label)
                 ))+
  scale_color_manual(values = pal_2or)+
  theme_bw()+
  labs(title = 'OBIS-GBIF Mifish PECO partners') +
  theme(legend.position = 'none',
        title = element_blank(),
        axis.text = element_blank(),
        panel.grid = element_blank(),
        axis.title = element_blank()
        )

ggsave(filename = here(pcoa_out, paste0(datefield, 'obisgbif_pcoa-site.png')),
       device = 'png', dpi=300, height = 8, width= 13,  units = "in")

ggsave(filename = here(pcoa_out, paste0(datefield, 'obisgbif_pcoa-site.pdf')),
       device = 'pdf', dpi=300, height = 8, width= 13,  units = "in")

# centroids of clusters
obisgbif_centroid <- obisgbif_mifish_plot %>%
  group_by(cluster) %>%
  mutate(centroid_x = mean(axis_1),
         centroid_y = mean(axis_2)) %>%
  ungroup() %>%
  select(cluster, centroid_x, centroid_y) %>%
    distinct()

# make a version where we can see the clusters
ggplot(obisgbif_mifish_plot, aes(x = axis_1, y = axis_2)) +
  geom_convexhull(aes(fill = as.factor(cluster)),
                  alpha=0.3) +
  # giving it the wrong value forces it to be grey
  scale_fill_manual(values = pal_2or)+
  geom_point(aes(x = axis_1, y = axis_2, 
                 col = as.factor(region_label)
                 ))+
  scale_color_manual(values = pal_2or)+
  ggrepel::geom_text_repel(data = obisgbif_centroid,
            aes(x = centroid_x,
                y = centroid_y,
                label = as.character(cluster)),
            size = 4) +
  theme_bw()+
  labs(title = 'Mifish PECO partners') +
  theme(legend.position = 'none',
        axis.text = element_blank(),
        panel.grid = element_blank(),
        axis.title = element_blank(),
        title = element_blank())

ggsave(filename = here(pcoa_out, paste0(datefield, 'obisgbif_pcoa-siteyear-motu-all_grey.png')),
       device = 'png', dpi=300, height = 8, width= 13,  units = "in")
```

```{r obisgbif tree}
obisgbif_cons <- read.tree(here(pcoa_out, 
                                '20251117_obisgbif-mifish_clusters-site.tre'))
#check for polytomies? true = good
is.binary(obisgbif_cons)

#set up labels
obisgbif_tree_plot <- obisgbif_mifish_plot %>%
  mutate(tip.label = as.factor(region_label))

ggtree(obisgbif_cons,
       # we only want the topology
       branch.length = 'none')  %<+%
  # add labels and coloring to ggtree
  obisgbif_tree_plot  +
  geom_text(aes(label=region_label), 
            # slightly off the tips
            position = position_nudge(x = -.05, y = -.5),
            size=5) +
  geom_point(aes(fill = tip.label),
             shape = 22,
             position = position_nudge(x = -.015, y = 0),
             size = 3) +
  scale_fill_manual(values = pal_2or)+
  geom_text(aes(label=cluster), hjust=1, vjust=1.4, size=3)+
  theme(legend.position = 'none') 

# save as pdf to edit in vectornator
ggsave(here(pcoa_out, paste0(datefield,'obisgbif-mifish-year_cluster_dendro-nodist.pdf')),
       height = 10,
       width = 7,
       units = 'in')
```

## obisgbif

```{r}
set.seed(20212022)

sitesp_all_pa <- obisgbif %>%
  filter(scientific_name %in% fishlist$species) %>%
  mutate(sp_pa = 1) %>%
  # combine sites data
  select(scientific_name, sp_pa, site_code) %>%
  distinct() %>%
  pivot_wider(id_cols = site_code,
              names_from = scientific_name, 
              values_from = sp_pa) %>%
  column_to_rownames('site_code') %>%
  # make binary
  mutate(across(.cols = everything(), ~replace(., is.na(.), 0)))

#distance matrix
obisgbif_mifish_jaccard <- as.matrix(vegdist(sitesp_all_pa, method = 'jaccard', binary = T))

#pcoa
obisgbif_mifish_pcoa <- pcoa(obisgbif_mifish_jaccard)
#vectors for plotting
obisgbif_mifish_pcoa_plot <- as.data.frame(obisgbif_mifish_pcoa$vectors) %>% 
  janitor::clean_names() %>%
  select(axis_1, axis_2) %>%
  rownames_to_column('site')


# basic clustering
## note most of these settings are default
# consensus tree of 100 trees
obisgbif_mifish_upgma <- recluster.cons(sitesp_all_pa, 
                              dist = 'jaccard', 
                              method = 'average',
                              tr = 100,
                              p = .5)

# write tree
ape::write.tree(obisgbif_mifish_upgma$cons, 
                here(pcoa_out, paste0(datefield, 'obisgbif-mifish_clusters-mifish.tre')))

# looking at cuts
# expldiss shows cluster attribution for each cut, 
## explained dissimilarity, and resulting clusters, so we can pick:
# pick cut that represents > 90% dissimilarity ($expl.div)
#NOTE: identical before and after polytomies
obisgbif_mifish_expldiss <- recluster.expl.diss(obisgbif_mifish_upgma$cons, 
                                                obisgbif_mifish_jaccard)
obisgbif_mifish_expldiss

# extracting group identities from matrix at chosen cut (column)
obisgbif_mifish_clusters <- obisgbif_mifish_expldiss$matrix[,1] %>%
  as.data.frame()

# prepare to plot
# combine cluster identities with PCoA axes and metadata
obisgbif_mifish_plot <- obisgbif_mifish_clusters %>%
  rename(cluster = '.') %>%
  rownames_to_column('site') %>%
  left_join(obisgbif_mifish_pcoa_plot) %>%
  left_join(obisgbif, by = c('site' = 'site_code')) %>%
  select(site, cluster, axis_1, axis_2) %>%
  distinct() %>%
  left_join(regions, by = c('site' = 'site_code')) %>%
  rename(site_code = site)

# plot with partners as hulls
ggplot(obisgbif_mifish_plot, aes(x = axis_1, y = axis_2)) +
  geom_convexhull(aes(fill = as.factor(region_label)),
                  alpha=0.4) +
  scale_fill_manual(values = pal_2or)+
  geom_point(aes(x = axis_1, y = axis_2, 
                 col = as.factor(region_label)
                 ))+
  scale_color_manual(values = pal_2or)+
  theme_bw()+
  labs(title = 'OBIS-GBIF Mifish PECO partners') +
  theme(legend.position = 'none',
        title = element_blank(),
        axis.text = element_blank(),
        panel.grid = element_blank(),
        axis.title = element_blank()
        )

ggsave(filename = here(pcoa_out, paste0(datefield, 'obisgbif_pcoa-mifish.png')),
       device = 'png', dpi=300, height = 8, width= 13,  units = "in")

ggsave(filename = here(pcoa_out, paste0(datefield, 'obisgbif_pcoa-mifish.pdf')),
       device = 'pdf', dpi=300, height = 8, width= 13,  units = "in")

# centroids of clusters
obisgbif_centroid <- obisgbif_mifish_plot %>%
  group_by(cluster) %>%
  mutate(centroid_x = mean(axis_1),
         centroid_y = mean(axis_2)) %>%
  ungroup() %>%
  select(cluster, centroid_x, centroid_y) %>%
    distinct()

# make a version where we can see the clusters
ggplot(obisgbif_mifish_plot, aes(x = axis_1, y = axis_2)) +
  geom_convexhull(aes(fill = as.factor(cluster)),
                  alpha=0.3) +
  # giving it the wrong value forces it to be grey
  scale_fill_manual(values = pal_2or)+
  geom_point(aes(x = axis_1, y = axis_2, 
                 col = as.factor(region_label)
                 ))+
  scale_color_manual(values = pal_2or)+
  ggrepel::geom_text_repel(data = obisgbif_centroid,
            aes(x = centroid_x,
                y = centroid_y,
                label = as.character(cluster)),
            size = 4) +
  theme_bw()+
  labs(title = 'Mifish PECO partners') +
  theme(legend.position = 'none',
        axis.text = element_blank(),
        panel.grid = element_blank(),
        axis.title = element_blank(),
        title = element_blank())

ggsave(filename = here(pcoa_out, paste0(datefield, 'obisgbif_pcoa-site-motu-all_grey.png')),
       device = 'png', dpi=300, height = 8, width= 13,  units = "in")
```


```{r obisgbif tree}
obisgbif_cons <- read.tree(here(pcoa_out, 
                                '20251117_obisgbif-mifish_clusters-mifish.tre'))
#check for polytomies? true = good
is.binary(obisgbif_cons)

#set up labels
obisgbif_tree_plot <- obisgbif_mifish_plot %>%
  mutate(tip.label = as.factor(region_label))

ggtree(obisgbif_cons,
       # we only want the topology
       branch.length = 'none')  %<+%
  # add labels and coloring to ggtree
  obisgbif_tree_plot  +
  geom_text(aes(label=region_label), 
            # slightly off the tips
            position = position_nudge(x = -.05, y = -.5),
            size=5) +
  geom_point(aes(fill = tip.label),
             shape = 22,
             position = position_nudge(x = -.015, y = 0),
             size = 3) +
  scale_fill_manual(values = pal_2or)+
  geom_text(aes(label=cluster), hjust=1, vjust=1.4, size=3)+
  theme(legend.position = 'none') 

# save as pdf to edit in vectornator
ggsave(here(pcoa_out, paste0(datefield,'obisgbif-mifish_cluster_dendro-nodist.pdf')),
       height = 10,
       width = 7,
       units = 'in')
```



## OBIS-GBIF all

These are all fish found in our region and for all years

```{r obisgbif-unfiltered}
set.seed(20212022)

sitesp_all_pa <- obisgbif %>%
  mutate(sp_pa = 1) %>%
  # region name clumps nearby partners, region code does not
  select(scientific_name, sp_pa, site_code) %>%
  distinct() %>%
  pivot_wider(id_cols = site_code,
              names_from = scientific_name, 
              values_from = sp_pa) %>%
  column_to_rownames('site_code') %>%
  # make binary
  mutate(across(.cols = everything(), ~replace(., is.na(.), 0)))

#distance matrix
obisgbif_unfilter_jaccard <- as.matrix(vegdist(sitesp_all_pa, method = 'jaccard', binary = T))

#pcoa
obisgbif_unfilter_pcoa <- pcoa(obisgbif_unfilter_jaccard)
#vectors for plotting
obisgbif_unfilter_pcoa_plot <- as.data.frame(obisgbif_unfilter_pcoa$vectors) %>% 
  janitor::clean_names() %>%
  select(axis_1, axis_2) %>%
  rownames_to_column('site')


# basic clustering
## note most of these settings are default
# consensus tree of 100 trees
obisgbif_unfilter_upgma <- recluster.cons(sitesp_all_pa, 
                              dist = 'jaccard', 
                              method = 'average',
                              tr = 100,
                              p = .5)

# write tree
ape::write.tree(obisgbif_unfilter_upgma$cons, 
                here(pcoa_out, 
                     paste0(datefield, 'obisgbif-unfilter_clusters-site.tre')))


# looking at cuts
# expldiss shows cluster attribution for each cut, 
## explained dissimilarity, and resulting clusters, so we can pick:
# pick cut that represents > 90% dissimilarity ($expl.div)
#NOTE: identical before and after polytomies
obisgbif_unfilter_expldiss <- recluster.expl.diss(obisgbif_unfilter_upgma$cons, obisgbif_unfilter_jaccard)
obisgbif_unfilter_expldiss

# extracting group identities from matrix at chosen cut (column)
obisgbif_unfilter_clusters <- obisgbif_unfilter_expldiss$matrix[,15] %>%
  as.data.frame()

# prepare to plot
# combine cluster identities with PCoA axes and metadata
obisgbif_unfilter_plot <- obisgbif_unfilter_clusters %>%
  rename(cluster = '.') %>%
  rownames_to_column('site') %>%
  left_join(obisgbif_unfilter_pcoa_plot) %>%
  left_join(obisgbif, by = c('site' = 'site_code')) %>%
  select(site, cluster, axis_1, axis_2) %>%
  distinct() %>%
  left_join(regions, by = c('site' = 'site_code')) %>%
  rename(site_code = site)

# plot with partners as hulls
ggplot(obisgbif_unfilter_plot, aes(x = axis_1, y = axis_2)) +
  geom_convexhull(aes(fill = as.factor(region_label)),
                  alpha=0.4) +
  scale_fill_manual(values = pal_2or)+
  geom_point(aes(x = axis_1, y = axis_2, 
                 col = as.factor(region_label)
                 ))+
  scale_color_manual(values = pal_2or)+
  theme_bw()+
  #labs(title = 'obis-gbif all fish') +
  theme(legend.position = 'none',
        axis.text = element_blank(),
        panel.grid = element_blank(),
        axis.title = element_blank())

ggsave(filename = here(pcoa_out, paste0(datefield, 'obisgbif_pcoa-site_unfiltered.png')),
       device = 'png', dpi=300, height = 8, width= 13,  units = "in")

ggsave(filename = here(pcoa_out, paste0(datefield, 'obisgbif_pcoa-site_unfiltered.pdf')),
       device = 'pdf', dpi=300, height = 8, width= 13,  units = "in")
```

```{r unfiltered-tree}
unfilter_cons <- read.tree(here(pcoa_out, 
                                '20251117_obisgbif-unfilter_clusters-site.tre'))
#check for polytomies? true = good
is.binary(unfilter_cons)

unfilter_tree_plot <- obisgbif_unfilter_plot %>%
  mutate(tip.label = as.factor(region_label))

ggtree(unfilter_cons,
       branch.length = 'none')  %<+%
  # add labels and coloring to ggtree
  unfilter_tree_plot  +
  geom_text(aes(label=region_label), 
            # slightly off the tips
            position = position_nudge(x = -.05, y = -.5),
            size=5) +
  geom_point(aes(fill = tip.label),
             shape = 22,
             position = position_nudge(x = -.015, y = 0),
             size = 3) +
  scale_fill_manual(values = pal_2or)+
  geom_text(aes(label=cluster), hjust=1, vjust=1.4, size=3)+
  theme(legend.position = 'none') 

# as PDF to edit in vectornator
ggsave(here(pcoa_out, paste0(datefield,'obisgbif-unfilter_cluster_dendro-nodist.pdf')),
       height = 10,
       width = 7,
       units = 'in')
```

## eDNA 2021

```{r edna 2021}
set.seed(2021)

sitesp_2021_pa <- mifish_edna %>%
  filter(year == 2021) %>%
  # for some reason this one isn't showing up as a species
  # region name clumps nearby partners, region code does not
  select(motu, motu_pa, site_code) %>%
  distinct() %>%
  filter(!(is.na(site_code))) %>%
  pivot_wider(id_cols = site_code,
              names_from = motu, 
              values_from = motu_pa) %>%
  column_to_rownames('site_code') %>%
  # make binary
  mutate(across(.cols = everything(), ~replace(., is.na(.), 0)))

#distance matrix
mifish_2021_jaccard <- as.matrix(vegdist(sitesp_2021_pa, method = 'jaccard', binary = T))

#pcoa
mifish_2021_pcoa <- pcoa(mifish_2021_jaccard)
#vectors for plotting
mifish_2021_pcoa_plot <- as.data.frame(mifish_2021_pcoa$vectors) %>% 
  janitor::clean_names() %>%
  select(axis_1, axis_2) %>%
  rownames_to_column('site')


# basic clustering
## note most of these settings are default
# consensus tree of 100 trees
mifish_2021_upgma <- recluster.cons(sitesp_2021_pa, 
                              dist = 'jaccard', 
                              method = 'average',
                              tr = 100,
                              p = .5)

# write tree
ape::write.tree(mifish_2021_upgma$cons, 
                here(pcoa_out, paste0(datefield, 'region-2021_clusters-motu.tre')))

# looking at cuts
# expldiss shows cluster attribution for each cut, 
## explained dissimilarity, and resulting clusters, so we can pick:
# pick cut that represents > 90% dissimilarity ($expl.div)
#NOTE: identical before and after polytomies
mifish_2021_expldiss <- recluster.expl.diss(mifish_2021_upgma$cons, mifish_2021_jaccard)
mifish_2021_expldiss

# extracting group identities from matrix at chosen cut (column)
mifish_2021_clusters <- mifish_2021_expldiss$matrix[,16] %>%
  as.data.frame()


# prepare to plot
# combine cluster identities with PCoA axes and metadata
mifish_2021_plot <- mifish_2021_clusters %>%
  rename(cluster = '.') %>%
  rownames_to_column('site') %>%
  left_join(mifish_2021_pcoa_plot) %>%
  left_join(mifish_edna, by = c('site' = 'site_code')) %>%
  select(site, cluster, axis_1, axis_2,
         region_code) %>%
  distinct() %>%
  left_join(regions)

# MB only has 2 points
mb_line2021 <- mifish_2021_plot %>%
  filter(region_code == "CA_MB")


# plot with partners as hulls
ggplot(mifish_2021_plot, aes(x = axis_1, y = axis_2)) +
  geom_convexhull(aes(fill = as.factor(region_label)),
                  alpha=0.4) +
  scale_fill_manual(values = pal_2or,
                    limits = region_order$region_label,
                    labels = region_order$region_label)+
          # line between morro bay dots
  geom_line(data = mb_line2021, 
            aes(x = axis_1, y = axis_2),
            color = "#E56512",
            alpha = 0.4,
            size =3) +
  geom_point(aes(x = axis_1, y = axis_2, 
                 col = as.factor(region_label)
                 ))+
  scale_color_manual(values = pal_2or,
                    limits = region_order$region_label,
                    labels = region_order$region_label)+
  theme_bw()+
  theme(legend.position = 'none',
        axis.text = element_blank(),
        panel.grid = element_blank(),
        axis.title = element_blank())

ggsave(filename = here(pcoa_out, paste0(datefield, 'peco_pcoa-site-motu-2021.pdf')),
       device = 'pdf', dpi=300, height = 8, width= 8,  units = "in")

# tree
mifish_2021_cons <- read.tree(here(pcoa_out, 
                                   paste0(datefield, 'region-2021_clusters-motu.tre')))
#check for polytomies? true = good
is.binary(mifish_2021_cons)

mifish_2021_tree_plot <- mifish_2021_plot %>%
  mutate(tip.label = as.factor(region_name)) 

ggtree(mifish_2021_cons,
       branch.length = 'none') %<+% 
  # add labels and coloring to ggtree
  mifish_2021_tree_plot +
  geom_text(aes(label=region_label), 
            # slightly off the tips
            position = position_nudge(x = -.05, y = -.5),
          size=5) +
  geom_point(aes(fill = region_label),
             shape = 22,
             position = position_nudge(x = .015, y = 0),
             size = 3) +
  scale_fill_manual(values = pal_2or,
                    limits = region_order$region_label)+
  geom_text(aes(label=cluster), 
            hjust=0, vjust=0, size=3)+
  theme(legend.position = 'none') 

ggsave(filename = here(pcoa_out, paste0(datefield,'region-tree_2021.pdf')),
       height = 11,
       width = 4,
       unit = 'in')
```

## eDNA 2022

```{r by-site 2022}
set.seed(2021)

sitesp_2022_pa <- mifish_edna %>%
  filter(year == 2022) %>%
  # for some reason this one isn't showing up as a species
  # region name clumps nearby partners, region code does not
  select(motu, motu_pa, site_code) %>%
  distinct() %>%
  filter(!(is.na(site_code))) %>%
  pivot_wider(id_cols = site_code,
              names_from = motu, 
              values_from = motu_pa) %>%
  column_to_rownames('site_code') %>%
  # make binary
  mutate(across(.cols = everything(), ~replace(., is.na(.), 0)))

#distance matrix
mifish_2022_jaccard <- as.matrix(vegdist(sitesp_2022_pa, method = 'jaccard', binary = T))

#pcoa
mifish_2022_pcoa <- pcoa(mifish_2022_jaccard)
#vectors for plotting
mifish_2022_pcoa_plot <- as.data.frame(mifish_2022_pcoa$vectors) %>% 
  janitor::clean_names() %>%
  select(axis_1, axis_2) %>%
  rownames_to_column('site')


# basic clustering
## note most of these settings are default
# consensus tree of 100 trees
mifish_2022_upgma <- recluster.cons(sitesp_2022_pa, 
                              dist = 'jaccard', 
                              method = 'average',
                              tr = 100,
                              p = .5)

ape::write.tree(mifish_2022_upgma$cons, here(pcoa_out, 
                                            paste0(datefield, 'region-2022_clusters-motu.tre')))

# looking at cuts
# expldiss shows cluster attribution for each cut, 
## explained dissimilarity, and resulting clusters, so we can pick:
# pick cut that represents > 90% dissimilarity ($expl.div)
#NOTE: identical before and after polytomies
mifish_2022_expldiss <- recluster.expl.diss(mifish_2022_upgma$cons, mifish_2022_jaccard)
mifish_2022_expldiss

# extracting group identities from matrix at chosen cut (column)
mifish_2022_clusters <- mifish_2022_expldiss$matrix[,14] %>%
  as.data.frame()


# prepare to plot
# combine cluster identities with PCoA axes and metadata
mifish_2022_plot <- mifish_2022_clusters %>%
  rename(cluster = '.') %>%
  rownames_to_column('site') %>%
  left_join(mifish_2022_pcoa_plot) %>%
  left_join(mifish_edna, by = c('site' = 'site_code')) %>%
  select(site, cluster, axis_1, axis_2,
         region_code) %>%
  distinct() %>%
  left_join(regions)

# MB only has 2 points
mb_line2022 <- mifish_2022_plot %>%
  filter(region_code == "CA_MB")

ggplot(mifish_2022_plot, aes(x = axis_1, y = axis_2)) +
  geom_convexhull(aes(fill = as.factor(region_label)),
                  alpha=0.4) +
  scale_fill_manual(values = pal_2or,
                    limits = region_order$region_label,
                    labels = region_order$region_label)+
          # line between morro bay dots
  geom_line(data = mb_line2022, 
            aes(x = axis_1, y = axis_2),
            color = "#E56512",
            alpha = 0.4,
            size =3) +
  geom_point(aes(x = axis_1, y = axis_2, 
                 col = as.factor(region_label)
                 ))+
  scale_color_manual(values = pal_2or,
                    limits = region_order$region_label,
                    labels = region_order$region_label)+
  theme_bw()+
  theme(legend.position = 'none',
        axis.text = element_blank(),
        panel.grid = element_blank(),
        axis.title = element_blank())

ggsave(filename = here(pcoa_out, paste0(datefield, 'peco_pcoa-site-motu-2022.pdf')),
       device = 'pdf', dpi=300, height = 8, width= 8,  units = "in")

# tree
mifish_2022_cons <- read.tree(here(pcoa_out, 
                                   paste0(datefield, 'region-2022_clusters-motu.tre')))
#check for polytomies? true = good
is.binary(mifish_2022_cons)

mifish_2022_tree_plot <- mifish_2022_plot %>%
  mutate(tip.label = as.factor(region_name)) 

ggtree(mifish_2022_cons,
       branch.length = 'none') %<+% 
  # add labels and coloring to ggtree
  mifish_2022_tree_plot +
  geom_text(aes(label=region_label), 
            # slightly off the tips
            position = position_nudge(x = -.05, y = -.5),
          size=5) +
  geom_point(aes(fill = region_label),
             shape = 22,
             position = position_nudge(x = .015, y = 0),
             size = 3) +
  scale_fill_manual(values = pal_2or,
                    limits = region_order$region_label)+
  geom_text(aes(label=cluster), 
            hjust=0, vjust=0, size=3)+
  theme(legend.position = 'none') 

ggsave(filename = here(pcoa_out, paste0(datefield,'region-tree_2022.pdf')),
       height = 11,
       width = 4,
       unit = 'in')
```
## eDNA 2023

```{r by-site 2023}
set.seed(2021)

sitesp_2023_pa <- mifish_edna %>%
  filter(year == 2023) %>%
  # for some reason this one isn't showing up as a species
  # region name clumps nearby partners, region code does not
  select(motu, motu_pa, site_code) %>%
  distinct() %>%
  filter(!(is.na(site_code))) %>%
  pivot_wider(id_cols = site_code,
              names_from = motu, 
              values_from = motu_pa) %>%
  column_to_rownames('site_code') %>%
  # make binary
  mutate(across(.cols = everything(), ~replace(., is.na(.), 0)))

#distance matrix
mifish_2023_jaccard <- as.matrix(vegdist(sitesp_2023_pa, method = 'jaccard', binary = T))

#pcoa
mifish_2023_pcoa <- pcoa(mifish_2023_jaccard)
#vectors for plotting
mifish_2023_pcoa_plot <- as.data.frame(mifish_2023_pcoa$vectors) %>% 
  janitor::clean_names() %>%
  select(axis_1, axis_2) %>%
  rownames_to_column('site')


# basic clustering
##  note most of these settings are default
# consensus tree of 100 trees
mifish_2023_upgma <- recluster.cons(sitesp_2023_pa, 
                              dist = 'jaccard', 
                              method = 'average',
                              tr = 100,
                              p = .5)

# write tree
ape::write.tree(mifish_2023_upgma$cons, here(pcoa_out, 
                                            paste0(datefield, 'region-2023_clusters-motu.tre')))


# looking at cuts
# expldiss shows cluster attribution for each cut, 
## explained dissimilarity, and resulting clusters, so we can pick:
# pick cut that represents > 90% dissimilarity ($expl.div)
#NOTE: identical before and after polytomies
mifish_2023_expldiss <- recluster.expl.diss(mifish_2023_upgma$cons, mifish_2023_jaccard)
mifish_2023_expldiss

# extracting group identities from matrix at chosen cut (column)
mifish_2023_clusters <- mifish_2023_expldiss$matrix[,10] %>%
  as.data.frame()


# prepare to plot
# combine cluster identities with PCoA axes and metadata
mifish_2023_plot <- mifish_2023_clusters %>%
  rename(cluster = '.') %>%
  rownames_to_column('site') %>%
  left_join(mifish_2023_pcoa_plot) %>%
  left_join(mifish_edna, by = c('site' = 'site_code')) %>%
  select(site, cluster, axis_1, axis_2,
         region_code) %>%
  distinct() %>%
  left_join(regions)

# MB only has 2 points
mb_line2023 <- mifish_2023_plot %>%
  filter(region_code == "CA_MB")

# partner as hull
ggplot(mifish_2023_plot, aes(x = axis_1, y = axis_2)) +
  geom_convexhull(aes(fill = as.factor(region_label)),
                  alpha=0.4) +
  scale_fill_manual(values = pal_2or,
                    limits = region_order$region_label,
                    labels = region_order$region_label)+
          # line between morro bay dots
  geom_line(data = mb_line2023, 
            aes(x = axis_1, y = axis_2),
            color = "#E56512",
            alpha = 0.4,
            size =3) +
  geom_point(aes(x = axis_1, y = axis_2, 
                 col = as.factor(region_label)
                 ))+
  scale_color_manual(values = pal_2or,
                    limits = region_order$region_label,
                    labels = region_order$region_label)+
  theme_bw()+
  theme(legend.position = 'none',
        axis.text = element_blank(),
        panel.grid = element_blank(),
        axis.title = element_blank())

ggsave(filename = here(pcoa_out, paste0(datefield, 'peco_pcoa-site-motu-2023.pdf')),
       device = 'pdf', dpi=300, height = 8, width= 8,  units = "in")

# tree
mifish_2023_cons <- read.tree(here(pcoa_out, 
                                   paste0(datefield, 'region-2023_clusters-motu.tre')))
#check for polytomies? true = good
is.binary(mifish_2023_cons)

mifish_2023_tree_plot <- mifish_2023_plot %>%
  mutate(tip.label = as.factor(region_name)) 

ggtree(mifish_2023_cons,
       branch.length = 'none') %<+% 
  # add labels and coloring to ggtree
  mifish_2023_tree_plot +
  geom_text(aes(label=region_label), 
            # slightly off the tips
            position = position_nudge(x = -.05, y = -.5),
          size=5) +
  geom_point(aes(fill = region_label),
             shape = 22,
             position = position_nudge(x = .015, y = 0),
             size = 3) +
  scale_fill_manual(values = pal_2or,
                    limits = region_order$region_label)+
  geom_text(aes(label=cluster), 
            hjust=0, vjust=0, size=3)+
  theme(legend.position = 'none') 

ggsave(filename = here(pcoa_out, paste0(datefield,'region-tree_2023.pdf')),
       height = 11,
       width = 4,
       unit = 'in')
```

## eDNA 2024

```{r by-site 2024}
set.seed(2021)

sitesp_2024_pa <- mifish_edna %>%
  filter(year == 2024) %>%
  # region name clumps nearby partners, region code does not
  select(motu, motu_pa, site_code) %>%
  distinct() %>%
  filter(!(is.na(site_code))) %>%
  pivot_wider(id_cols = site_code,
              names_from = motu, 
              values_from = motu_pa) %>%
  column_to_rownames('site_code') %>%
  #? empty row
  janitor::remove_empty() %>%
  # make binary
  mutate(across(.cols = everything(), ~replace(., is.na(.), 0)))

#distance matrix
mifish_2024_jaccard <- as.matrix(vegdist(sitesp_2024_pa, method = 'jaccard', binary = T))

#pcoa
mifish_2024_pcoa <- pcoa(mifish_2024_jaccard)
#vectors for plotting
mifish_2024_pcoa_plot <- as.data.frame(mifish_2024_pcoa$vectors) %>% 
  janitor::clean_names() %>%
  select(axis_1, axis_2) %>%
  rownames_to_column('site')


# basic clustering
##  note most of these settings are default
# consensus tree of 100 trees
mifish_2024_upgma <- recluster.cons(sitesp_2024_pa, 
                              dist = 'jaccard', 
                              method = 'average',
                              tr = 100,
                              p = .5)

# write tree
ape::write.tree(mifish_2024_upgma$cons, here(pcoa_out, 
                                            paste0(datefield, 'region-2024_clusters-motu.tre')))

# looking at cuts
# expldiss shows cluster attribution for each cut, 
## explained dissimilarity, and resulting clusters, so we can pick:
# pick cut that represents > 90% dissimilarity ($expl.div)
#NOTE: identical before and after polytomies
mifish_2024_expldiss <- recluster.expl.diss(mifish_2024_upgma$cons, mifish_2024_jaccard)
mifish_2024_expldiss

# extracting group identities from matrix at chosen cut (column)
mifish_2024_clusters <- mifish_2024_expldiss$matrix[,11] %>%
  as.data.frame()


# prepare to plot
# combine cluster identities with PCoA axes and metadata
mifish_2024_plot <- mifish_2024_clusters %>%
  rename(cluster = '.') %>%
  rownames_to_column('site') %>%
  left_join(mifish_2024_pcoa_plot) %>%
  left_join(mifish_edna, by = c('site' = 'site_code')) %>%
  select(site, cluster, axis_1, axis_2,
         region_code) %>%
  distinct() %>%
  left_join(regions)


# MB only has 2 points
mb_line2024 <- mifish_2024_plot %>%
  filter(region_code == "CA_MB")

# regions as hulls
ggplot(mifish_2024_plot, aes(x = axis_1, y = axis_2)) +
  geom_convexhull(aes(fill = as.factor(region_label)),
                  alpha=0.4) +
  scale_fill_manual(values = pal_2or,
                    limits = region_order$region_label,
                    labels = region_order$region_label)+
        # line between morro bay dots
  geom_line(data = mb_line2024, 
            aes(x = axis_1, y = axis_2),
            color = "#E56512",
            alpha = 0.4,
            size =3) +
  geom_point(aes(x = axis_1, y = axis_2, 
                 col = as.factor(region_label)
                 ))+
  scale_color_manual(values = pal_2or,
                    limits = region_order$region_label,
                    labels = region_order$region_label)+
  theme_bw()+
  theme(legend.position = 'none',
        axis.text = element_blank(),
        panel.grid = element_blank(),
        axis.title = element_blank())

ggsave(filename = here(pcoa_out, paste0(datefield, 'peco_pcoa-site-motu-2024.pdf')),
       device = 'pdf', dpi=300, height = 8, width= 8,  units = "in")


# tree
mifish_2024_cons <- read.tree(here(pcoa_out, 
                                   paste0(datefield, 'region-2024_clusters-motu.tre')))
#check for polytomies? true = good
is.binary(mifish_2024_cons)

mifish_2024_tree_plot <- mifish_2024_plot %>%
  mutate(tip.label = as.factor(region_name)) 

ggtree(mifish_2024_cons,
       branch.length = 'none') %<+% 
  # add labels and coloring to ggtree
  mifish_2024_tree_plot +
  geom_text(aes(label=region_label), 
            # slightly off the tips
            position = position_nudge(x = -.05, y = -.5),
          size=5) +
  geom_point(aes(fill = region_label),
             shape = 22,
             position = position_nudge(x = .015, y = 0),
             size = 3) +
  scale_fill_manual(values = pal_2or,
                    limits = region_order$region_label)+
  geom_text(aes(label=cluster), 
            hjust=0, vjust=0, size=3)+
  theme(legend.position = 'none') 

ggsave(filename = here(pcoa_out, paste0(datefield,'region-tree_2024.pdf')),
       height = 11,
       width = 4,
       unit = 'in')
```


## eDNA all

this one is by site-year

```{r}
set.seed(2021)

siteyear_pa <- mifish_edna %>%
  # for some reason this one isn't showing up as a species
  # region name clumps nearby partners, region code does not
  select(motu, motu_pa, site_code, year) %>%
  filter(!(is.na(site_code))) %>%
  mutate(siteyear = paste0(site_code, '-', year)) %>%
  select(!c(site_code, year)) %>%
  distinct() %>%
  pivot_wider(id_cols = siteyear,
              names_from = motu, 
              values_from = motu_pa) %>%
  column_to_rownames('siteyear') %>%
  # make binary
  mutate(across(.cols = everything(), ~replace(., is.na(.), 0)))

siteyear_meta <- mifish_edna %>%
  mutate(siteyear = paste0(site_code, '-', year)) %>%
  select(siteyear, region_name, region_code, year) %>%
  left_join(regions) %>%
  select(!c(site_code, decimal_latitude, decimal_longitude, samples, sites)) %>%
  distinct()

#distance matrix
mifish_all_jaccard <- as.matrix(vegdist(siteyear_pa, method = 'jaccard', binary = T))

#pcoa
mifish_all_pcoa <- pcoa(mifish_all_jaccard)
#vectors for plotting
mifish_all_pcoa_plot <- as.data.frame(mifish_all_pcoa$vectors) %>% 
  janitor::clean_names() %>%
  select(axis_1, axis_2) %>%
  rownames_to_column('site')


# basic clustering


# note most of these settings are default
# consensus tree of 100 trees
mifish_all_upgma <- recluster.cons(siteyear_pa, 
                              dist = 'jaccard', 
                              method = 'average',
                              tr = 100,
                              p = .5)

# write tree
ape::write.tree(mifish_all_upgma$cons, here(pcoa_out, 
                                            paste0(datefield, 'region-all_clusters-motu.tre')))

# looking at cuts
# expldiss shows cluster attribution for each cut, 
## explained dissimilarity, and resulting clusters, so we can pick:
# pick cut that represents > 90% dissimilarity ($expl.div)
#NOTE: identical before and after polytomies
mifish_all_expldiss <- recluster.expl.diss(mifish_all_upgma$cons, mifish_all_jaccard)
mifish_all_expldiss

# extracting group identities from matrix at chosen cut (column)
mifish_all_clusters <- mifish_all_expldiss$matrix[,1] %>%
  as.data.frame()


# prepare to plot
# combine cluster identities with PCoA axes and metadata
mifish_all_plot <- mifish_all_clusters %>%
  rename(cluster = '.') %>%
  rownames_to_column('site') %>%
  left_join(mifish_all_pcoa_plot) %>%
  left_join(siteyear_meta, by = c('site' = 'siteyear')) %>%
  select(site, cluster, axis_1, axis_2,
         region_name, year) %>%
  distinct() %>%
  left_join(regions) %>%
  select(!c(decimal_latitude, decimal_longitude, sites, samples)) %>%
  mutate(regionyear = paste0(region_label, ' - ', as.character(year))) %>%
  distinct() 

# MB only has 2 points
mb_line <- mifish_all_plot %>%
  filter(region_code == "CA_MB")

region_order3 <- mifish_edna %>%
  select(region_label, year) %>%
  distinct() %>%
  mutate(regionyear = paste0(region_label, ' - ', as.character(year))) %>%
  left_join(region_order2) %>%
  arrange(-region_lat_name, -year)

# centroids for clusters
mifish_centroid <- mifish_all_plot %>%
  group_by(cluster) %>%
  mutate(centroid_x = mean(axis_1),
         centroid_y = mean(axis_2)) %>%
  ungroup() %>%
  select(cluster, centroid_x, centroid_y) %>%
    distinct()

ggplot(mifish_all_plot, aes(x = axis_1, y = axis_2)) +
  geom_convexhull(aes(fill = as.factor(cluster)),
                  alpha=0.3) +
  # giving it the wrong value forces it to be grey
  scale_fill_manual(values = pal_2or)+
  geom_point(aes(x = axis_1, y = axis_2, 
                 col = as.factor(region_label)
                 ))+
  scale_color_manual(values = pal_2or)+
  ggrepel::geom_text_repel(data = mifish_centroid,
            aes(x = centroid_x,
                y = centroid_y,
                label = as.character(cluster)),
            size = 4) +
  theme_bw()+
  labs(title = 'Mifish PECO partners') +
  theme(legend.position = 'none',
        axis.text = element_blank(),
        panel.grid = element_blank(),
        axis.title = element_blank(),
        title = element_blank())

ggsave(filename = here(pcoa_out, paste0(datefield, 'peco_pcoa-siteyear-motu-all_grey.png')),
       device = 'png', dpi=300, height = 8, width= 13,  units = "in")

ggsave(filename = here(pcoa_out, paste0(datefield, 'peco_pcoa-siteyear-motu-all_grey.pdf')),
       device = 'pdf', dpi=300, height = 8, width= 13,  units = "in")

mifish_cons <- read.tree(here(pcoa_out, paste0(datefield, 'region-all_clusters-motu.tre')))
#check for polytomies? true = good
is.binary(mifish_cons)

mifish_tree_plot <- mifish_all_plot %>%
  mutate(region_labelyear = paste0(region_label, ' - ', as.character(year))) %>%
  mutate(tip.label = as.factor(region_labelyear)) 

ggtree(mifish_cons,
       branch.length = 'none') %<+% 
  # add labels and coloring to ggtree
  mifish_tree_plot +
  geom_text(aes(label=region_labelyear), 
            # slightly off the tips
            position = position_nudge(x = -.05, y = -.5),
          size=5) +
  geom_point(aes(fill = region_label),
             shape = 22,
             position = position_nudge(x = .015, y = 0),
             size = 3) +
  scale_fill_manual(values = pal_2or)+
  geom_text(aes(label=cluster), 
            hjust=0, vjust=0, size=3)+
  theme(legend.position = 'none') 

ggsave(filename = here(pcoa_out, paste0(datefield,'region-tree_siteyear.pdf')),
       height = 22,
       width = 4,
       unit = 'in')

```


# site no year

```{r}
set.seed(2021)

site_pa <- mifish_edna %>%
  # for some reason this one isn't showing up as a species
  # region name clumps nearby partners, region code does not
  select(motu, motu_pa, site_code) %>%
  filter(!(is.na(site_code))) %>%
  distinct() %>%
  pivot_wider(id_cols = site_code,
              names_from = motu, 
              values_from = motu_pa) %>%
  column_to_rownames('site_code') %>%
  # make binary
  mutate(across(.cols = everything(), ~replace(., is.na(.), 0)))

#distance matrix
mifish_site_jaccard <- as.matrix(vegdist(site_pa, method = 'jaccard', binary = T))

#pcoa
mifish_site_pcoa <- pcoa(mifish_site_jaccard)
#vectors for plotting
mifish_site_pcoa_plot <- as.data.frame(mifish_site_pcoa$vectors) %>% 
  janitor::clean_names() %>%
  select(axis_1, axis_2) %>%
  rownames_to_column('site')


# basic clustering


# note most of these settings are default
# consensus tree of 100 trees
mifish_site_upgma <- recluster.cons(site_pa, 
                              dist = 'jaccard', 
                              method = 'average',
                              tr = 100,
                              p = .5)

# looking at cuts
# expldiss shows cluster attribution for each cut, 
## explained dissimilarity, and resulting clusters, so we can pick:
# pick cut that represents > 90% dissimilarity ($expl.div)
#NOTE: identical before and after polytomies
mifish_site_expldiss <- recluster.expl.diss(mifish_site_upgma$cons, mifish_site_jaccard)
mifish_site_expldiss

# extracting group identities from matrix at chosen cut (column)
mifish_site_clusters <- mifish_site_expldiss$matrix[,15] %>%
  as.data.frame()


# prepare to plot
# combine cluster identities with PCoA axes and metadata
mifish_site_plot <- mifish_site_clusters %>%
  rename(cluster = '.') %>%
  rownames_to_column('site') %>%
  left_join(mifish_site_pcoa_plot) %>%
  left_join(mifish_edna, by = c('site' = 'site_code')) %>%
  select(site, cluster, axis_1, axis_2,
         region_code, year) %>%
  distinct() %>%
  left_join(regions) %>%
  select(!c(site_code, decimal_latitude, decimal_longitude)) %>%
  distinct()

# MB only has 2 points
mb_site_line <- mifish_site_plot %>%
  filter(region_code == "CA_MB")


ggplot(mifish_site_plot, aes(x = axis_1, y = axis_2)) +
  geom_convexhull(aes(fill = as.factor(region_label)),
                  alpha=0.4) +
          # line between morro bay dots
  geom_line(data = mb_site_line, 
            aes(x = axis_1, y = axis_2),
            color = "#E56512",
            alpha = 0.4,
            size =3) +
  scale_fill_manual(values = pal_2or,
                    limits = region_order$region_label,
                    labels = region_order$region_label)+
  geom_point(aes(x = axis_1, y = axis_2, 
                 col = as.factor(region_label)
                 ))+
  scale_color_manual(values = pal_2or,
                    limits = region_order$region_label,
                    labels = region_order$region_label)+
  theme_bw()+
  #labs(title = 'Mifish PECO partners') +
  theme(#legend.position = 'bottom',
    legend.position = 'none',
        axis.text = element_blank(),
        panel.grid = element_blank(),
        axis.title = element_blank(),
        title = element_blank())

ggsave(filename = here(pcoa_out, paste0(datefield, 'peco_pcoa-site-motu-site.png')),
       device = 'png', dpi=300, height = 8, width= 13,  units = "in")

ggsave(filename = here(pcoa_out, paste0(datefield, 'peco_pcoa-site-motu-site.pdf')),
       device = 'pdf', dpi=300, height = 8, width= 13,  units = "in")



ggplot(mifish_site_plot, aes(x = axis_1, y = axis_2)) +
  geom_convexhull(aes(fill = as.factor(cluster)),
                  alpha=0.3) +
  # giving it the wrong value forces it to be grey
  scale_fill_manual(values = pal_2or)+
  geom_point(aes(x = axis_1, y = axis_2, 
                 col = as.factor(region_label)
                 ))+
  scale_color_manual(values = pal_2or)+
  ggrepel::geom_text_repel(data = mifish_centroid,
            aes(x = centroid_x,
                y = centroid_y,
                label = as.character(cluster)),
            size = 4) +
  theme_bw()+
  labs(title = 'Mifish PECO partners') +
  theme(legend.position = 'none',
        axis.text = element_blank(),
        panel.grid = element_blank(),
        axis.title = element_blank(),
        title = element_blank())

ggsave(filename = here(pcoa_out, paste0(datefield, 'peco_pcoa-site-motu-all_grey.png')),
       device = 'png', dpi=300, height = 8, width= 13,  units = "in")

ggsave(filename = here(pcoa_out, paste0(datefield, 'peco_pcoa-site-motu-all_grey.pdf')),
       device = 'pdf', dpi=300, height = 8, width= 13,  units = "in")
```

```{r site tree all}
# write tree
ape::write.tree(mifish_site_upgma$cons, here(pcoa_out, paste0(datefield, 'region-site_clusters-motu.tre')))

mifish_cons <- read.tree(here(pcoa_out, paste0(datefield, 'region-site_clusters-motu.tre')))
#check for polytomies? true = good
is.binary(mifish_cons)

mifish_tree_plot <- mifish_site_plot %>%
  #mutate(node = as.numeric(cluster)) %>%
  mutate(tip.label = as.factor(region_label)) 

#tr_data <- mifish_tree$data 

ggtree(mifish_cons,
       branch.length = 'none') %<+% 
  # add labels and coloring to ggtree
  mifish_tree_plot +
  geom_text(aes(label=region_label), 
            # slightly off the tips
            position = position_nudge(x = -.05, y = -.5),
            # left justify
            #hjust=1, 
          size=5) +
  geom_point(aes(fill = region_label),
             shape = 22,
             position = position_nudge(x = .015, y = 0),
             size = 3) +
  scale_fill_manual(values = pal_2or)+
  #scale_shape_manual(values = shape_pal) +
  geom_text(aes(label=cluster), 
            hjust=0, vjust=0, size=3)+
  #scale_x_reverse(expand = c(0, .5)) +
  theme(#plot.margin = unit(c(2,1,1,4), "cm"),
        legend.position = 'none') 

ggsave(filename = here(pcoa_out, paste0(datefield,'region-tree_site.pdf')),
       height = 11,
       width = 4,
       unit = 'in')


```








# pc1 vs latitude

## OBIS-GBIF 
Both matched and unmatched

```{r pc vs lat obisgbif}
ggplot(obisgbif_mifish_plot) +
  geom_point(aes(y = axis_1, 
                 x = factor(region_label, levels = region_order2$region_label),
                 fill = region_label),
             shape = 21,
             colour = 'black',
             alpha = .6,
             size = 1) +
  geom_boxplot(aes(y = axis_1, 
                 x = factor(region_label, levels = region_order2$region_label),
                 fill = region_label),
               colour = 'black',
               alpha = .6,
               horizontal = TRUE) +
  scale_color_manual(values = pal_2or,
                    limits = region_order$region_label,
                    labels = region_order$region_label) +
  scale_fill_manual(values = pal_2or,
                    limits = region_order$region_label,
                    labels = region_order$region_label) +
  # horizontal!
  coord_flip() +
  labs(x = NULL, y = 'PC1') +
  theme_bw()+
    theme(legend.position = 'none',
        panel.grid = element_blank()
        )

ggsave(filename = here(pcoa_out, paste0(datefield, 
                                    'obisgbif-mifish_pc1xlat_boxplot-site.pdf')),
       device = 'pdf', height = 6, width= 10,  units = "in")

# ggplot(obisgbif_unfilter_plot) +
#   geom_point(aes(y = axis_1, 
#                  x = factor(regionyear, levels = region_order3$regionyear),
#                  fill = region_label),
#              shape = 21,
#              colour = 'black',
#              alpha = .6,
#              size = 1) +
#   geom_boxplot(aes(y = axis_1, 
#                  x = factor(regionyear, levels = region_order3$regionyear),
#                  fill = region_label),
#                colour = 'black',
#                alpha = .6,
#                horizontal = TRUE) +
#   scale_color_manual(values = pal_2or,
#                     limits = region_order$region_label,
#                     labels = region_order$region_label) +
#   scale_fill_manual(values = pal_2or,
#                     limits = region_order$region_label,
#                     labels = region_order$region_label) +
#   # horizontal!
#   coord_flip() +
#   labs(x = NULL, y = 'PC1') +
#   theme_bw()+
#     theme(legend.position = 'none',
#         panel.grid = element_blank()
#         )
# 
# ggsave(filename = here(pcoa_out, paste0(datefield, 
#                                     'obisgbif-unfiltered_pc1xlat_boxplot-site.pdf')),
#        device = 'pdf', height = 6, width= 10,  units = "in")

```

## eDNA - all

```{r pdf version for combined plot}
ggplot(mifish_all_plot) +
  geom_point(aes(y = axis_1, 
                 x = factor(regionyear, levels = region_order3$regionyear),
                 fill = region_label),
             shape = 21,
             colour = 'black',
             alpha = .8,
             size = 1) +
  geom_boxplot(aes(y = axis_1, 
                 x = factor(regionyear, levels = region_order3$regionyear),
                 fill = region_label),
               colour = 'black',
               alpha = .6) +
  scale_color_manual(values = pal_2or,
                    limits = region_order$region_label,
                    labels = region_order$region_label) +
  scale_fill_manual(values = pal_2or,
                    limits = region_order$region_label,
                    labels = region_order$region_label) +
  # horizontal!
  coord_flip() +
  labs(x = NULL, y = 'PC1') +
  theme_bw()+
    theme(legend.position = 'none',
        panel.grid = element_blank()
        )

ggsave(filename = here(pcoa_out, paste0(datefield, 
                                    'peco_pc1xlat-siteyear-motu_pa_boxplot-site.pdf')),
       device = 'pdf', height = 10, width= 10,  units = "in")

```

# summary stats

Check variance explained etc.
Remember:
eigenvalue / total == proportion of variance explained
```{r summary stats}
# obisgbif filtered to mifish
summary(capscale(obisgbif_mifish_jaccard ~ 1))
# total variance explained
obisgbif_mifish_pcoa$trace
# PC1
obisgbif_mifish_pcoa$values$Eigenvalues[1]/obisgbif_mifish_pcoa$trace
# PC2
obisgbif_mifish_pcoa$values$Eigenvalues[2]/obisgbif_mifish_pcoa$trace
# first 2 axes
(obisgbif_mifish_pcoa$values$Eigenvalues[1]/obisgbif_mifish_pcoa$trace) +
  (obisgbif_mifish_pcoa$values$Eigenvalues[2]/obisgbif_mifish_pcoa$trace)

# obisgbif unfiltered
summary(capscale(obisgbif_unfilter_jaccard ~ 1))
# total variance explained
obisgbif_unfilter_pcoa$trace
# PC1
obisgbif_unfilter_pcoa$values$Eigenvalues[1]/obisgbif_unfilter_pcoa$trace
# PC2
obisgbif_unfilter_pcoa$values$Eigenvalues[2]/obisgbif_unfilter_pcoa$trace
# first 2 axes
(obisgbif_unfilter_pcoa$values$Eigenvalues[1]/obisgbif_unfilter_pcoa$trace) +
  (obisgbif_unfilter_pcoa$values$Eigenvalues[2]/obisgbif_unfilter_pcoa$trace)

# mifish, all
# total variance explained
mifish_all_pcoa$trace
# PC1
mifish_all_pcoa$values$Eigenvalues[1]/mifish_all_pcoa$trace
# PC2
mifish_all_pcoa$values$Eigenvalues[2]/mifish_all_pcoa$trace
# first 2 axes
(mifish_all_pcoa$values$Eigenvalues[1]/mifish_all_pcoa$trace) +
  (mifish_all_pcoa$values$Eigenvalues[2]/mifish_all_pcoa$trace)

```






# semiquantitative

## site

```{r}
set.seed(2021)

sitesp_all_sq <- mifish_edna %>%
  #filter(year == 2024) %>%
  # for some reason this one isn't showing up as a species
  # region name clumps nearby partners, region code does not
  select(motu, relabund_vst_motu, site_code) %>%
  distinct() %>%
  filter(!(is.na(site_code))) %>%
  pivot_wider(id_cols = site_code,
              names_from = motu, 
              values_from = relabund_vst_motu,
              values_fn = sum) %>%
  column_to_rownames('site_code') %>%
  # make binary
  mutate(across(.cols = everything(), ~replace(., is.na(.), 0)))

#distance matrix
mifish_all_bc <- as.matrix(vegdist(sitesp_all_sq, method = 'bray'))

#pcoa
mifish_all_sq_pcoa <- pcoa(mifish_all_bc)
#vectors for plotting
mifish_all_sq_pcoa_plot <- as.data.frame(mifish_all_sq_pcoa$vectors) %>% 
  janitor::clean_names() %>%
  select(axis_1, axis_2) %>%
  rownames_to_column('site')


# basic clustering


# note most of these settings are default
# consensus tree of 100 trees
mifish_all_sq_upgma <- recluster.cons(sitesp_all_sq, 
                              #dist = 'jaccard', 
                              method = 'average',
                              tr = 100,
                              p = .5)

# looking at cuts
# expldiss shows cluster attribution for each cut, 
## explained dissimilarity, and resulting clusters, so we can pick:
# pick cut that represents > 90% dissimilarity ($expl.div)
#NOTE: identical before and after polytomies
mifish_all_sq_expldiss <- recluster.expl.diss(mifish_all_sq_upgma$cons, mifish_all_bc)
mifish_all_sq_expldiss

# extracting group identities from matrix at chosen cut (column)
mifish_all_sq_clusters <- mifish_all_sq_expldiss$matrix[,1] %>%
  as.data.frame()


# prepare to plot
# combine cluster identities with PCoA axes and metadata
mifish_all_sq_plot <- mifish_all_sq_clusters %>%
  rename(cluster = '.') %>%
  rownames_to_column('site') %>%
  left_join(mifish_all_sq_pcoa_plot) %>%
  left_join(mifish_edna, by = c('site' = 'site_code')) %>%
  select(site, cluster, axis_1, axis_2,
         region_code) %>%
  distinct() %>%
  left_join(regions)


ggplot(mifish_all_sq_plot, aes(x = axis_1, y = axis_2)) +
  geom_convexhull(aes(fill = as.factor(region_label)),
                  alpha=0.4) +
  scale_fill_manual(values = pal_2or,
                    limits = region_order$region_label,
                    labels = region_order$region_label)+
  geom_point(aes(x = axis_1, y = axis_2, 
                 col = as.factor(region_label)
                 ))+
  scale_color_manual(values = pal_2or,
                    limits = region_order$region_label,
                    labels = region_order$region_label)+
  theme_bw()+
  labs(title = 'Mifish PECO partners') +
  theme(legend.position = 'bottom',
        axis.text = element_blank(),
        panel.grid = element_blank(),
        axis.title = element_blank(),
        title = element_blank())

ggsave(filename = here(pcoa_out, paste0(datefield, 'peco_pcoa-site-motu_semiquantitative.png')),
       device = 'png', dpi=300, height = 8, width= 13,  units = "in")

ggsave(filename = here(pcoa_out, paste0(datefield, 'peco_pcoa-site-motu_semiquantitative.pdf')),
       device = 'pdf', dpi=300, height = 10, width= 13,  units = "in")
```
```{r}
# write tree
ape::write.tree(mifish_all_sq_upgma$cons, here(pcoa_out, paste0(datefield, 'region-sq_clusters-motu.tre')))

mifish_cons <- read.tree(here(pcoa_out, paste0(datefield, 'region-sq_clusters-motu.tre')))
#check for polytomies? true = good
is.binary(mifish_cons)

mifish_tree_plot <- mifish_all_sq_plot %>%
  #mutate(node = as.numeric(cluster)) %>%
  mutate(tip.label = as.factor(region_name)) 

ggtree(mifish_cons,
       branch.length = 'none') %<+% 
  # move pelagic to the top
  #flip(94, 106) %<+%
  # add labels and coloring to ggtree
  mifish_tree_plot +
  geom_text(aes(label=region_label), 
            # slightly off the tips
            position = position_nudge(x = -.05, y = -.5),
            # left justify
            #hjust=1, 
          size=5) +
  geom_point(aes(fill = region_label),
             shape = 22,
             position = position_nudge(x = .015, y = 0),
             size = 3) +
  scale_fill_manual(values = pal_2or,
                    limits = region_order$region_label)+
  #scale_shape_manual(values = shape_pal) +
  geom_text(aes(label=cluster), hjust=-.25, vjust=1.5, size=5)+
  #scale_x_reverse(expand = c(0, .5)) +
  theme(#plot.margin = unit(c(2,1,1,4), "cm"),
        legend.position = 'none') 


ggsave(filename = here(pcoa_out, paste0(datefield,'region-tree_sq.pdf')),
       height = 20,
       width = 6,
       unit = 'in')

```


---
title: "Calculate and explore thermal affinities"
author: "Kate Sheridan"
date: "`r Sys.Date()`"
output: html_document
---

Model thermal affinities as function of region values;
sst, extreme temps, upwelling

Note throughout this script CTI and STI are used as shorthand for thermal affinity of the community and species thermal affinity.

lmer for mixed effect models, blme when it is singular. no p values reported for singular models.


```{r setup, include=FALSE}
#install.packages('optimx')
library(tidyverse)
library(here)
library(matrixStats)
#library(nlme) # remove if i remove?
library(lme4)
library(blme)
library(lmerTest)
library(optimx)
library(ggeffects)

# here filepaths
obisdata = here('rawdata', 'bigdata', 'obis_cti')
dataedna <- here('processeddata', 'peco', '2021-24_edna')
plotout <- here('output', 'thermalaffinity', 'models')
datefield <- '20251111_'

pal_2or <- c("Juneau Region, Alaska" = "#00496F",
             "Southeast Alaska" = "#03587B",
             "Haida Gwaii, British Columbia" = "#076787",
             "Central Coast British Columbia" = "#0B7693",
             "North Vancouver Island, British Columbia" = "#0F85A0",
             "Inner Coast, British Columbia" = "#469989",
             "Pacific Rim Park, British Columbia" = "#7EAE73",
             "Puget Sound & Padilla Bay, Washington" = "#B5C25C",
             "Willapa Bay, Washington" = "#EDD746",
             "Yaquina Bay, Oregon" = "#EDC334",
             "Coos Bay, Oregon" = "#EDB123",
             "Humboldt Bay, California" = "#ED9E11",
             "Bodega Bay, California" = "#ED8B00",
             "San Francisco Bay, California" = "#E97809",
             "Morro Bay, California" = "#E56512",
             "Los Angeles, California" = "#E1531B",
             "San Diego region, California" = "#DD4124")
```

```{r loadin}
regions <- read_csv(here(dataedna, '20251111_peco_region-name-plotting.csv'))[-1] %>%
  rename(region_label = region_name_label)


region_order <- regions %>%
  select(region_lat_name, region_name, region_label, avg_region_lat) %>% 
  distinct() %>%
  arrange(-avg_region_lat)

site_order <- regions %>%
  select(site_code, decimal_latitude) %>%
  arrange(decimal_latitude)

edna_peco <- read_csv(here('processeddata', 'peco', '2021-24_edna',
                             '20251111_peco-combined_12s_asvmatrix_fish.csv'))[-1] %>%
  filter(rank == 'species') %>%
  rename(region_label = region_name_label) %>%
  # remove below threshold
  filter(relabund_vst_taxa > 1) %>%
  # problematic sample
  filter(!(sample_id %in% c('pecoe-0207')))

# STIs

sti_obis <- read_csv(here('rawdata', 'bigdata', 'obis_cti',
                          '20250803_sti_errdap_pathfinder.csv')) %>%
  rename(found_taxa = scientific_name) 

# environment
region_environment <- read_csv(here('rawdata', 'temp', 'erddap', 
                                   '20250713_mean-summer-sst_by-region.csv')) 

region_temps <- region_environment %>%
  filter(year %in% c(2021, 2022, 2023, 2024)) %>%
  distinct() %>%
  select(!avg_region_lat) %>%
  mutate(region_label = case_when(region_label == 'San Fransisco Bay, California' ~ 'San Francisco Bay, California',
                                       TRUE ~ region_label))

site_environment <- read_csv(here('rawdata', 'temp', 'erddap',
                                   '20250713_summer-sst-summary-stats_by-site.csv'))


site_temps <- site_environment %>%
  filter(year %in% c(2021, 2022, 2023, 2024)) %>%
  select(!c(decimal_latitude, decimal_longitude))%>%
  select(!c(avg_region_lat)) %>%
    mutate(region_label = case_when(region_label == 'San Fransisco Bay, California' ~ 'San Francisco Bay, California',
                                       TRUE ~ region_label))
```

## thermal affinities

get the values needed for the model; same as in 09a thermal-affinity

```{r calculate cti and sti}
# CTI
cti_peco <- edna_peco %>%
  select(!asv) %>%
  distinct() %>%
  left_join(sti_obis) %>%
  filter(!is.na(max_temp)) %>%
  # temporary until I merge [1]
  janitor::remove_empty() %>%
  group_by(site_code, year) %>%
  # weighted mean and SD from matrixStats package
  summarise(cti = weightedMean(sti_value, relabund_vst_taxa),
            ctdiv = weightedSd(sti_value, relabund_vst_taxa),
            ctr = weightedMean(temp_q_span95, relabund_vst_taxa),
            # 95% in most of the papers
            tbiasmax = weightedMean(temp_95, relabund_vst_taxa),
            tbiasmin = weightedMean(temp_05, relabund_vst_taxa),
            # 90 for comparison, maybe?
            tbiasmax90 = weightedMean(temp_90, relabund_vst_taxa),
            tbiasmin10 = weightedMean(temp_10, relabund_vst_taxa),
            ctr90 = weightedMean(temp_q_span, relabund_vst_taxa),) %>%
  ungroup() %>%
  left_join(regions) %>%
  select(!c(decimal_latitude, decimal_longitude, samples, sites)) %>%
  distinct() %>%
  left_join(site_order)


cti_environment <- cti_peco %>%
  select(!c(region_code, region_code_label, region_lat_name, avg_region_lat)) %>%
  rename(
         cti_value = cti) %>%
  left_join(site_temps) %>%
  #left_join(region_temps) %>%
  mutate(sitegroup = fct_reorder(as_factor(site_code), year, .fun = first)) %>%
  # fill in with means if NA
  group_by(region_label, year) %>%
  mutate(region_mean = mean(sst_mean, na.rm = TRUE),
         region_95 = mean(site_temp95, na.rm = TRUE),
         region_75 = mean(site_temp75, na.rm = TRUE),
         region_05 = mean(site_temp05, na.rm = TRUE)) %>%
  ungroup() %>%
  mutate(sst_mean = coalesce(sst_mean, region_mean),
         site_temp95 = coalesce(site_temp95, region_95),
         site_temp75 = coalesce(site_temp75, region_75),
         site_temp05 = coalesce(site_temp05, region_05)) %>%
  select(!c(region_95, region_75, region_05, region_mean,
            site_temp90, site_temp25, site_temp10))

# STI
sti_peco <- edna_peco %>%
  select(!c(region_code,  decimal_latitude, decimal_longitude,
            extraction_blank, library,
            seagrass_presence, seagrass_notes, describe_transect,
            notes, collection_time_24h, notes_about_sample,
            extraction_notes, organization_participants, reads_adjust,
            filtration_comments, dna_extraction_date, biological_observations,
            collection_method, treatment, evalue, identity_percentage,
            relabund_wis_taxa, relabund_wis_motu, pcr_blank, 
            #bsaredo, lab_notes, 
            reads_adjust_fieldlab, reads_raw, reads_adjust_field,
            reads_adjust_lab, kingdom, phylum, rain, asv)) %>%
  left_join(sti_obis) %>%
  filter(!is.na(max_temp)) %>%
  # temporary until I merge [1]
  janitor::remove_empty() %>%
  left_join(regions) %>%
  select(!c(decimal_latitude, decimal_longitude, samples, avg_region_lat,
            sites, region_code_label, region_code, region_lat_name)) %>%
  distinct() %>%
  relocate(sti_value, region_label)
  
sti_environment <- sti_peco %>%
  left_join(site_temps) %>%
    # fill in with means if NA
  group_by(region_label, year) %>%
  mutate(region_mean = mean(sst_mean, na.rm = TRUE)) %>%
  ungroup() %>%
    # fill in with means if NA
  group_by(region_label, year) %>%
  mutate(region_mean = mean(sst_mean, na.rm = TRUE),
         region_95 = mean(site_temp95, na.rm = TRUE),
         region_75 = mean(site_temp75, na.rm = TRUE),
         region_05 = mean(site_temp05, na.rm = TRUE)) %>%
  ungroup() %>%
  mutate(sst_mean = coalesce(sst_mean, region_mean),
         site_temp95 = coalesce(site_temp95, region_95),
         site_temp75 = coalesce(site_temp75, region_75),
         site_temp05 = coalesce(site_temp05, region_05)) %>%
  select(!c(region_95, region_75, region_05, region_mean,
            site_temp90, site_temp25, site_temp10))
  #left_join(region_temps)
```




# CTI

## 95

```{r cti-sst ctis region}
region_list <- unique(regions$region_name)

region_output <- {}

fixed_output <- {}

random_output <- {}

# loop to run model for every region
for (i in 1:length(region_list)) {
  print(region_list[i])
  
  region_subset <- cti_environment %>%
    filter(region_name == region_list[i])
  
  #region_model <- lme(cti_value ~ site_temp95,random=~1|site_code,
  #                    data=region_subset)
  region_model <- lmer(cti_value ~ site_temp95 + (1 | site_code), 
                       data = region_subset)
  
  singular <- isSingular(region_model)
  
  if (singular == TRUE){
    print('Model is singular')
      region_model <- blmer(cti_value ~ site_temp95 + (1 | site_code), 
                       data = region_subset)
  }
  
  model_summary <- summary(region_model)
  
  #pr_t is the same as the anova result now
  #modelanova <- anova(region_model)
  
  region_sd <- model_summary$sigma
  
  ttable <- data.frame(model_summary$coefficients) %>%
    mutate(region_name = region_list[i]) %>%
    mutate(aic = model_summary$AICtab) %>%
    rownames_to_column('term') %>%
    janitor::clean_names() %>%
    rename(intercept = estimate) %>%
    mutate(sd = region_sd) %>%
    mutate(singular = singular)
  
  region_output <- region_output %>%
    bind_rows(ttable)
  
  random_effects <- data.frame(ranef(region_model)) %>%
    rownames_to_column('site_code') %>%
    janitor::clean_names() %>%
    #rename(intercept = "x_intercept") %>%
    mutate(region_name = region_list[i])
  
  random_output <- random_output %>%
    bind_rows(random_effects)
  
    # make a ggpredict plot object
  region_y <- ggpredict(region_model) %>% 
    plot()
  
  # subset sti values
  sti_4plot <- sti_peco %>%
    left_join(cti_environment) %>%
    filter(region_name == region_list[i]) 
  
  # add sti and cti to ggpredict plot
  region_y +
    # points for sti vs sst
    geom_point(data = sti_4plot,
               aes(y = sti_value,
                 x = site_temp95,
                 color = region_label,
                 size = relabund_vst_taxa),
             alpha = .35) +
    scale_size(range = c(.1,3)) +
    # points for cti vs temp, red diamonds
  geom_point(data = sti_4plot,
             aes(y = cti_value,
                 x = site_temp95),
             shape = 23,
             size = 3,
             fill = 'red') +
  scale_color_manual(values = pal_2or) +
   # scale_x_continuous(limits = c(14,15.75)) +
  labs(x = '95th percentile Summer SST', y = 'Thermal affinity',
       title = NULL)+
  theme_bw() +
  theme(legend.position = 'none',
        axis.text = element_text(size = 4),
        axis.title = element_text(size = 4))
  
  # pdf for figures
  ggsave(here(plotout, paste0(datefield, 'sti-sst95_region-',
                                     region_list[i], '.pdf')),
         height = 2,
         width = 2,
         units = 'in')
}

cti_95_out <- region_output %>%
    #or change string in every column of dataframe
  mutate(across(.cols = where(is.numeric),
                .fns = ~ round(., digits = 3))) %>%
  mutate(model = '95th')

cti_95_random <- random_output %>%
    #or change string in every column of dataframe
  mutate(across(.cols = where(is.numeric),
                .fns = ~ round(., digits = 3))) %>%
  mutate(model = '95th')

cti_95_out %>%
  filter(term == 'site_temp95') %>%
  mutate(std_positive = intercept + std_error,
         std_negative = intercept - std_error,
         significant = ifelse(pr_t < .05, 'yes', 'no')
         ) %>%
  left_join(region_order)%>%
  mutate(region_label = factor(region_label, 
                               levels = region_order$region_label)) %>%
  ggplot(aes(x = intercept,
             y = fct_rev(region_label))) +
  geom_vline(xintercept = 0,
             color = "grey50",
             size = .75,
             linetype = "dashed") +
  geom_errorbar(aes(xmin = std_negative,
                    xmax = std_positive)) +
  geom_point(aes(fill = significant),
             size = 1.5,
             shape = 21) +
  #scale_fill_manual(values = c('white', 'black')) +
  scale_fill_manual(values = c('white', 'black', 'grey50')) +
  theme_bw() +
  theme(axis.title.y = element_blank(),
        axis.text = element_text(size = 5),
        axis.title.x = element_blank(),
        panel.grid.minor = element_blank(),
        legend.position = 'none')


ggsave(here(plotout, paste0(datefield, 'cti-sst95_all-regions.pdf')),
       height = 2.5,
       width = 4,
       units = 'in')

write_csv(cti_95_out, here(plotout, paste0(datefield, '95-out.csv')))
write_csv(cti_95_random, here(plotout, paste0(datefield, '95-random.csv')))

model_summary$varcor$site_code["stddev"]
model_summary$varcor
model_summary$sigma
model_summary

test2 <- attr(model_summary$varcor$site_code, 'stddev')

test2
model_summary

str(model_summary$varcor)

test <- VarCorr(region_model)

test["StdDev"]
```




## 75

```{r cti-sst ctis region}
region_list <- unique(regions$region_name)

region_output <- {}

fixed_output <- {}

random_output <- {}

# loop to run for all regions
for (i in 1:length(region_list)) {
  print(region_list[i])
  
  region_subset <- cti_environment %>%
    filter(region_name == region_list[i])
  
  region_model <- lmer(cti_value ~ site_temp75 + (1 | site_code), 
                       data = region_subset)
  
  singular <- isSingular(region_model)
  
  if (singular == TRUE){
    print('Model is singular')
      region_model <- blmer(cti_value ~ site_temp75 + (1 | site_code), 
                       data = region_subset)
  }
  
  model_summary <- summary(region_model)
  
  region_sd <- model_summary$sigma
  
  ttable <- data.frame(model_summary$coefficients) %>%
    mutate(region_name = region_list[i]) %>%
    mutate(aic = model_summary$AICtab) %>%
    rownames_to_column('term') %>%
    janitor::clean_names() %>%
    rename(intercept = estimate) %>%
    mutate(sd = region_sd) %>%
    mutate(singular = singular)
  
  region_output <- region_output %>%
    bind_rows(ttable)
  
  random_effects <- data.frame(ranef(region_model)) %>%
    rownames_to_column('site_code') %>%
    janitor::clean_names() %>%
    #rename(intercept = "x_intercept") %>%
    mutate(region_name = region_list[i])
  
  random_output <- random_output %>%
    bind_rows(random_effects)
  
  
    # make a ggpredict plot object
  region_y <- ggpredict(region_model) %>% 
    plot()
  
  # subset sti values
  sti_4plot <- sti_peco %>%
    left_join(cti_environment) %>%
    filter(region_name == region_list[i]) 
  
  # add sti and cti to ggpredict plot
  region_y +
    # points for sti vs sst
    geom_point(data = sti_4plot,
               aes(y = sti_value,
                 x = site_temp75,
                 color = region_label,
                 size = relabund_vst_taxa),
             alpha = .35) +
    scale_size(range = c(.1,3)) +
    # points for cti vs temp, red diamonds
  geom_point(data = sti_4plot,
             aes(y = cti_value,
                 x = site_temp75),
             shape = 23,
             size = 3,
             fill = 'red') +
  scale_color_manual(values = pal_2or) +
   # scale_x_continuous(limits = c(14,15.75)) +
    #facet_wrap('site_code') +
  labs(x = '75th percentile Summer SST', y = 'Thermal affinity',
       title = NULL)+
  theme_bw() +
  theme(legend.position = 'none',
        axis.text = element_text(size = 4),
        axis.title = element_text(size = 4))
  
  # pdf for figures
  ggsave(here(plotout, paste0(datefield, 'sti-sst75_region-',
                                     region_list[i], '.pdf')),
         height = 2,
         width = 2,
         units = 'in')
}

cti_75_out <- region_output %>%
    #or change string in every column of dataframe
  mutate(across(.cols = where(is.numeric),
                .fns = ~ round(., digits = 3))) %>%
  mutate(model = '75th')

cti_75_random <- random_output %>%
    #or change string in every column of dataframe
  mutate(across(.cols = where(is.numeric),
                .fns = ~ round(., digits = 3))) %>%
  mutate(model = '75th')

cti_75_out %>%
  filter(term == 'site_temp75') %>%
  mutate(std_positive = intercept + std_error,
         std_negative = intercept - std_error,
         significant = ifelse(pr_t < .05, 'yes', 'no')
         ) %>%
  left_join(region_order)%>%
  mutate(region_label = factor(region_label, levels = region_order$region_label)) %>%
  ggplot(aes(x = intercept,
             y = fct_rev(region_label))) +
  geom_vline(xintercept = 0,
             color = "grey50",
             size = .75,
             linetype = "dashed") +
  geom_errorbar(aes(xmin = std_negative,
                    xmax = std_positive)) +
  geom_point(aes(fill = significant),
             size = 1.5,
             shape = 21) +
  scale_fill_manual(values = c('white', 'black', 'grey50')) +
  theme_bw() +
  theme(axis.title.y = element_blank(),
        axis.text = element_text(size = 5),
        axis.title.x = element_blank(),
        panel.grid.minor = element_blank(),
        legend.position = 'none')

# pdf version 
ggsave(here(plotout, paste0(datefield, 'cti-sst75_all-regions.pdf')),
       height = 2.5, width = 4, units = 'in')


write_csv(cti_75_out, here(plotout, paste0(datefield, '75-out.csv')))
write_csv(cti_75_random, here(plotout, paste0(datefield, '75-random.csv')))
```

## mean sst

```{r cti-sst ctis region}
region_list <- unique(regions$region_name)

region_output <- {}

fixed_output <- {}

random_output <- {}

for (i in 1:length(region_list)) {
  print(region_list[i])
  
  region_subset <- cti_environment %>%
    filter(region_name == region_list[i]) 
  
  region_model <- lmer(cti_value ~ sst_mean + (1 | site_code), 
                       data = region_subset)
  
  singular <- isSingular(region_model)
  
  if (singular == TRUE){
    print('Model is singular')
      region_model <- blmer(cti_value ~ sst_mean + (1 | site_code), 
                       data = region_subset)
  }
  
  model_summary <- summary(region_model)
  
  region_sd <- model_summary$sigma
  
  ttable <- data.frame(model_summary$coefficients) %>%
    mutate(region_name = region_list[i]) %>%
    mutate(aic = model_summary$AICtab) %>%
    rownames_to_column('term') %>%
    janitor::clean_names() %>%
    rename(intercept = estimate) %>%
    mutate(sd = region_sd) %>%
    mutate(singular = singular)
  
  region_output <- region_output %>%
    bind_rows(ttable)
  
  random_effects <- data.frame(ranef(region_model)) %>%
    rownames_to_column('site_code') %>%
    janitor::clean_names() %>%
    #rename(intercept = "x_intercept") %>%
    mutate(region_name = region_list[i])
  
  random_output <- random_output %>%
    bind_rows(random_effects)
  
  # plot
    # make a ggpredict plot object
  region_y <- ggpredict(region_model) %>% 
    plot()
  
  # subset sti values
  sti_4plot <- sti_peco %>%
    left_join(cti_environment) %>%
    filter(region_name == region_list[i]) 
  
  # add sti and cti to ggpredict plot
  region_y +
    # points for sti vs sst
    geom_point(data = sti_4plot,
               aes(y = sti_value,
                 x = sst_mean,
                 color = region_label,
                 size = relabund_vst_taxa),
             alpha = .35) +
    scale_size(range = c(.1,3)) +
    # points for cti vs temp, red diamonds
  geom_point(data = sti_4plot,
             aes(y = cti_value,
                 x = sst_mean),
             shape = 23,
             size = 3,
             fill = 'red') +
  scale_color_manual(values = pal_2or) +
   # scale_x_continuous(limits = c(14,15.75)) +
    #facet_wrap('site_code') +
  labs(x = 'Mean summer SST', y = 'Thermal affinity',
       title = NULL)+
  theme_bw() +
  theme(legend.position = 'none',
        axis.text = element_text(size = 4),
        axis.title = element_text(size = 4))
  
  # pdf for figures
  ggsave(here(plotout, paste0(datefield, 'sti-sstmean_region-',
                                     region_list[i], '.pdf')),
         height = 2,
         width = 2,
         units = 'in')
  
  # plot of lines per site 
  pred_pop <- predict(region_model, re.form = NA) ## whole population level
  region_subset$pred_group <- predict(region_model) ## group level
  
  
  
  ggplot(data = region_subset, 
       mapping = aes(x = sst_mean, y = cti_value)) + 
    geom_point(data = sti_4plot,
             aes(y = cti_value,
                 x = sst_mean),
             shape = 23,
             size = 2,
             fill = 'red') +
  geom_line(aes(y = pred_group,
                color = region_label,
                linetype = site_code)) + 
  scale_color_manual(values = pal_2or) +
  geom_line(mapping = aes(y = pred_pop), colour = "black") + 
  theme(legend.position = "bottom") +
  labs(x = 'Mean summer SST', y = 'Thermal affinity',
       title = NULL)+
  theme_bw() +
  theme(legend.position = 'none',
        axis.text = element_text(size = 4),
        axis.title = element_text(size = 4))

    # pdf for figures
  ggsave(here(plotout, paste0(datefield, 'sti-sstmean_line-region-',
                                     region_list[i], '.pdf')),
         height = 2.5,
         width = 5.5,
         units = 'in')
}

cti_mean_out <- region_output %>%
    #or change string in every column of dataframe
  mutate(across(.cols = where(is.numeric),
                .fns = ~ round(., digits = 3))) %>%
  mutate(model = 'mean')

cti_mean_random <- random_output %>%
    #or change string in every column of dataframe
  mutate(across(.cols = where(is.numeric),
                .fns = ~ round(., digits = 3))) %>%
  mutate(model = 'mean')

cti_mean_out %>%
  filter(term == 'sst_mean') %>%
  mutate(std_positive = intercept + std_error,
         std_negative = intercept - std_error,
         significant = ifelse(pr_t < .05, 'yes', 'no')
         ) %>%
  left_join(region_order)%>%
  mutate(region_label = factor(region_label, levels = region_order$region_label)) %>%
  ggplot(aes(x = intercept,
             y = fct_rev(region_label))) +
  geom_vline(xintercept = 0,
             color = "grey50",
             size = .75,
             linetype = "dashed") +
  geom_errorbar(aes(xmin = std_negative,
                    xmax = std_positive)) +
  geom_point(aes(fill = significant),
             size = 1.5,
             shape = 21) +
  scale_fill_manual(values = c('white', 'black', 'grey50')) +
  theme_bw() +
  theme(axis.title.y = element_blank(),
        axis.text.y = element_text(size = 5),
        axis.title.x = element_blank(),
        panel.grid.minor = element_blank(),
        legend.position = 'none')

# pdf version 
ggsave(here(plotout, paste0(datefield, 'cti-sstmean_all-regions-wide.pdf')),
       height = 2.5, width = 5.5, units = 'in')

# pdf version 
ggsave(here(plotout, paste0(datefield, 'cti-sstmean_all-regions.pdf')),
       height = 2.5, width = 4, units = 'in')


write_csv(cti_mean_out, here(plotout, paste0(datefield, 'mean-out.csv')))
write_csv(cti_mean_random, here(plotout, paste0(datefield, 'mean-random.csv')))

```
### scatter plots with models for all regions




# upwelling

The California Current system is often defined by upwelling in different parts of the year and regions. The effects of upwelling may be different than simple sst though sst and upwelling are correlated.

```{r prep upwelling}
beuti_raw <- read_csv(here("rawdata", "upwelling", 
                            "20250515beuti-1degdaily_peco-summer.csv"))

beuti_index_year <- beuti_raw %>%
  group_by(year, latitude) %>%
  mutate(beuti_year = mean(beuti)) %>%
  ungroup() %>%
  select(!c(timestamps, month, beuti)) %>%
  distinct() %>%
  rename(beuti_lat = latitude)

beuti_cti_peco <- cti_peco %>%
  # filter to region/site within the index
  filter(avg_region_lat <= max(beuti_index_year$beuti_lat)) %>%
  # match latitude, don't round!
  # keep the site within the latitude it is in
  # remove decimals as a character and turn it back to a number
  # lol
  mutate(beuti_lat = as.character(avg_region_lat)) %>%
  mutate(beuti_lat = str_remove_all(beuti_lat, "\\.[0-9]*$")) %>%
  mutate(beuti_lat = as.numeric(beuti_lat)) %>%
  # join beuti!
  left_join(beuti_index_year) %>%
  relocate(beuti_year) %>%
  select(!c(region_lat_name)) %>%
  rename(cti_value = cti) %>%
  left_join(region_temps) %>%
  mutate(sitegroup = fct_reorder(as_factor(site_code), year, .fun = first)) 


beuti_sti_peco <- sti_peco %>%
  left_join(region_order) %>%
  #filter(region_name %in% beuti_cti_peco$region_name) %>%
  # filter to region/site within the index
  filter(avg_region_lat <= max(beuti_index_year$beuti_lat)) %>%
  # match latitude, don't round!
  # keep the site within the latitude it is in
  # remove decimals as a character and turn it back to a number
  # lol
  mutate(beuti_lat = as.character(avg_region_lat)) %>%
  mutate(beuti_lat = str_remove_all(beuti_lat, "\\.[0-9]*$")) %>%
  mutate(beuti_lat = as.numeric(beuti_lat)) %>%
  # join beuti!
  left_join(beuti_index_year) %>%
  relocate(beuti_year)

# sites and regions with beuti values
beuti_cti_peco %>% select(site_code) %>% distinct()
beuti_cti_peco %>% select(region_name) %>% distinct()
```


```{r upwelling plots}
# region cti vs upwelling
ggplot(beuti_cti_peco) +
  geom_point(aes(x = beuti_year, 
                y = cti_value,
                group = year,
                color = as.factor(year))) +
  scale_color_manual(values = c('#015B58FF', '#2C6184FF', '#89689DFF', '#BA7999FF')) +
  facet_wrap('region_name', scales = 'free') +
    labs(color = NULL,x = 'BEUTI upwelling index', y = 'Community Thermal Index', title = 'CTI vs BEUTI upwelling index') +
  theme_bw() +
  theme(legend.position = 'none',
        panel.grid.minor = element_blank())

ggsave(here(plotout, paste0(datefield, 'ctivsbeauti-year_facet.png')),
        height = 2000,
       width = 3000,
       unit = 'px')


# region beuti vs sst
ggplot(beuti_cti_peco) +
  geom_point(aes(x = beuti_year, 
                y = sst_mean,
                group = year,
                color = as.factor(region_label))) +
  scale_color_manual(values = pal_2or) +
    labs(color = NULL,x = 'BEUTI upwelling index', y = 'Mean summer SST') +
  theme_bw() +
  theme(legend.position = 'none',
        panel.grid.minor = element_blank())

ggsave(here(plotout, paste0(datefield, 'sstvsbeauti-region.png')),
        height = 2000,
       width = 3000,
       unit = 'px')
```


```{r cti-beuti ctis region}
region_list_upwell <- unique(beuti_cti_peco$region_name)

region_output <- {}

fixed_output <- {}

random_output <- {}

for (i in 1:length(region_list_upwell)) {
  print(region_list_upwell[i])
  
  region_subset <- beuti_cti_peco %>%
    filter(region_name == region_list_upwell[i]) #%>%
    #filter(year > 2021)
  
region_model <- lmer(cti_value ~ beuti_year + (1 | site_code), 
                       data = region_subset)
  
  singular <- isSingular(region_model)
  
  if (singular == TRUE){
    print('Model is singular')
      region_model <- blmer(cti_value ~ beuti_year + (1 | site_code), 
                       data = region_subset)
  }
  
  model_summary <- summary(region_model)
  
  region_sd <- model_summary$sigma
  
  ttable <- data.frame(model_summary$coefficients) %>%
    mutate(region_name = region_list_upwell[i]) %>%
    mutate(aic = model_summary$AICtab) %>%
    rownames_to_column('term') %>%
    janitor::clean_names() %>%
    rename(intercept = estimate) %>%
    mutate(sd = region_sd) %>%
    mutate(singular = singular)
  
  region_output <- region_output %>%
    bind_rows(ttable)
  
  random_effects <- data.frame(ranef(region_model)) %>%
    rownames_to_column('site_code') %>%
    janitor::clean_names() %>%
    #rename(intercept = "x_intercept") %>%
    mutate(region_name = region_list_upwell[i])
  
  random_output <- random_output %>%
    bind_rows(random_effects)
  
  # plot
    # make a ggpredict plot object
  region_y <- ggpredict(region_model) %>% 
    plot()
  
  # subset sti values
  sti_4plot <- beuti_sti_peco %>%
    left_join(beuti_cti_peco) %>%
    filter(region_name == region_list_upwell[i]) 
  
  # add sti and cti to ggpredict plot
  region_y +
    # points for sti vs sst
    geom_point(data = sti_4plot,
               aes(y = sti_value,
                 x = beuti_year,
                 color = region_label,
                 size = relabund_vst_taxa),
             alpha = .35) +
    scale_size(range = c(.1,3)) +
    # points for cti vs temp, red diamonds
  geom_point(data = sti_4plot,
             aes(y = cti_value,
                 x = beuti_year),
             shape = 23,
             size = 3,
             fill = 'red') +
  scale_color_manual(values = pal_2or) +
   # scale_x_continuous(limits = c(14,15.75)) +
    #facet_wrap('site_code') +
  labs(x = 'BEUTI upwelling index', y = 'Thermal affinity',
       title = NULL)+
  theme_bw() +
  theme(legend.position = 'none',
        axis.text = element_text(size = 4),
        axis.title = element_text(size = 4))
  
  # pdf for figures
  ggsave(here(plotout, paste0(datefield, 'sti-upwelling_region-',
                                     region_list_upwell[i], '.pdf')),
         height = 2,
         width = 2,
         units = 'in')
  
}

cti_upwelling_out <- region_output %>%
    #or change string in every column of dataframe
  mutate(across(.cols = where(is.numeric),
                .fns = ~ round(., digits = 3))) %>%
  mutate(model = 'upwelling')

cti_upwelling_random <- random_output %>%
    #or change string in every column of dataframe
  mutate(across(.cols = where(is.numeric),
                .fns = ~ round(., digits = 3))) %>%
  mutate(model = 'upwelling')

region_output %>%
  filter(term == 'beuti_year') %>%
  mutate(std_positive = intercept + std_error,
         std_negative = intercept - std_error,
         significant = ifelse(pr_t < .05, 'yes', 'no')) %>%
  left_join(region_order)%>%
  mutate(region_label = factor(region_label, levels = region_order$region_label)) %>%
  ggplot(aes(x = intercept,
             y = fct_rev(region_label))) +
  geom_vline(xintercept = 0,
             color = "grey50",
             size = .75,
             linetype = "dashed") +
  geom_errorbar(aes(xmin = std_negative,
                    xmax = std_positive)) +
  
  geom_point(aes(fill = significant),
             shape = 21) +
  scale_fill_manual(values = c('white', 'black')) +
  labs(x = 'Effect size') +
  theme_bw() +
  theme(axis.title.y = element_blank(),
        legend.position = 'none',
        axis.text.y = element_text(size = 5),
        axis.title.x = element_text(size = 10))

ggsave(here(plotout, paste0(datefield, 'cti-beuti_all-regions.png')),
       width = 1200,
       height = 750,
       units = 'px')

write_csv(cti_upwelling_out, here(plotout, paste0(datefield, 'upwelling-out.csv')))
write_csv(cti_upwelling_random, here(plotout, paste0(datefield, 'upwelling-random.csv')))
```







# Haida Gwaii

Patterns for Haida Gwaii is likely driven by the geography of the region rather than year.

```{r haida gwaii plots}
hg_subset <- cti_environment %>%
    filter(region_name == "BC_HG") %>%
  mutate(side_hg = case_when(site_code %in% c('HG_TN', 'HG_LIE') ~ 'west',
                             site_code %in% c('HG_BH', 'HG_RI', 'HG_TK',
                                              'HG_SB') ~ 'east',
                             site_code %in% c('HG_ROI') ~ 'south',
                             site_code %in% c('HG_MDD', 'HG_DSD') ~ 'north',
                             site_code %in% c('HG_DN') ~ 'central')) %>%
  mutate(site_code_plot = str_remove_all(site_code, 'HG_'))

# mean  
hgmean_model <- blmer(cti_value ~ sst_mean + (1 | site_code), 
                       data = hg_subset)
  
# make a ggpredict plot object
# plot of lines per site 
hg_pred_pop <- predict(hgmean_model, re.form = NA) ## whole population level
hg_subset$pred_group <- predict(hgmean_model) ## group level

  
# subset sti values
hgsti_4plot <- sti_peco %>%
    left_join(cti_environment) %>%
    filter(region_name == "BC_HG") 


ggplot(data = hg_subset, 
       mapping = aes(x = sst_mean, y = cti_value)) + 
      # points for sti vs sst
    geom_point(data = hgsti_4plot,
               aes(y = sti_value,
                 x = sst_mean,
                 color = region_label,
                 size = relabund_vst_taxa),
             alpha = .35) +
    scale_size(range = c(.1,3)) +
    geom_point(data = hgsti_4plot,
             aes(y = cti_value,
                 x = sst_mean),
             shape = 23,
             size = 2,
             fill = 'red') +
  geom_line(aes(y = pred_group,
                color = region_label,
                linetype = site_code)) + 
  scale_color_manual(values = pal_2or) +
  geom_line(mapping = aes(y = hg_pred_pop), colour = "black") + 
  theme(legend.position = "bottom") +
  labs(x = 'Mean Summer SST', y = 'Thermal affinity',
       title = NULL)+
  facet_wrap('site_code') +
  theme_bw() +
  theme(legend.position = 'none',
        axis.text = element_text(size = 8),
        axis.title = element_text(size = 8))

# pdf for figures
ggsave(here(plotout, paste0(datefield, 'sti-sstmean_haidagwaii-sitefacet.pdf')),
         height = 6,
         width = 6,
         units = 'in')

```

# combine output

```{r table maybe}
table_output <- cti_95_out %>%
  bind_rows(cti_75_out, cti_mean_out, cti_upwelling_out) %>%
  left_join(region_order) %>%
  arrange(region_lat_name) %>%
  relocate(region_label) %>%
  select(!c(region_name, avg_region_lat, region_lat_name)) %>%
  mutate(term = case_when(term == '(Intercept)' ~ stringr::str_to_sentence(paste0(model, " intercept")),
                          term == 'beuti_year' ~ 'BEUTI index',
                          term == 'site_temp95' ~ '95th percentile SST',
                          term == 'site_temp75' ~ '75th percentile SST',
                          term == 'sst_mean' ~ 'Mean SST',
                          TRUE ~ term)) %>%
  mutate(blme = case_when(singular == TRUE ~ 'BLME',
                          singular == FALSE ~ NA_character_)) %>%
  select(!c(model, singular))

table_random <- cti_95_random %>%
  bind_rows(cti_75_random, cti_mean_random, cti_upwelling_random) %>%
  select(!c(site_code, grpvar, term)) %>%
  left_join(region_order) %>%
  arrange(region_lat_name) %>%
    relocate(region_label) %>%
  select(!c(region_name, avg_region_lat, region_lat_name)) 


write_csv(table_output, here(plotout, paste0(datefield, 'table-out.csv')))
write_csv(table_random, here(plotout, paste0(datefield, 'table-random.csv')))
```


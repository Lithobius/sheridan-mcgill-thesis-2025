---
title: "Calculate and explore thermal affinities"
author: "Kate Sheridan"
date: "`r Sys.Date()`"
output: html_document
---

Calculate and plot thermal affinities

Note throughout this script CTI and STI are used as shorthand for thermal affinity of the community and species thermal affinity.

```{r setup, include=FALSE}
library(tidyverse)
library(here)
library(matrixStats)

# here filepaths
obisdata = here('rawdata', 'bigdata', 'obis_cti')
dataedna <- here('processeddata', 'peco', '2021-24_edna')
plotout <- here('output', 'chapter2', 'thermalaffinity')
datefield <- '20251212_'

pal_2or <- c("Juneau Region, Alaska" = "#00496F",
             "Southeast Alaska" = "#03587B",
             "Haida Gwaii, British Columbia" = "#076787",
             "Central Coast British Columbia" = "#0B7693",
             "North Vancouver Island, British Columbia" = "#0F85A0",
             "Inner Coast, British Columbia" = "#469989",
             "Pacific Rim Park, British Columbia" = "#7EAE73",
             "Puget Sound & Padilla Bay, Washington" = "#B5C25C",
             "Willapa Bay, Washington" = "#EDD746",
             "Yaquina Bay, Oregon" = "#EDC334",
             "Coos Bay, Oregon" = "#EDB123",
             "Humboldt Bay, California" = "#ED9E11",
             "Bodega Bay, California" = "#ED8B00",
             "San Francisco Bay, California" = "#E97809",
             "Morro Bay, California" = "#E56512",
             "Los Angeles, California" = "#E1531B",
             "San Diego region, California" = "#DD4124")
```

```{r loadin}
# region info for plotting
regions <- read_csv(here(dataedna, '20251113_peco_region-name-plotting.csv'))[-1] %>%
  rename(region_label = region_name_label)

region_order <- regions %>%
  select(region_lat_name, region_name, region_label, avg_region_lat) %>% 
  distinct() %>%
  arrange(-avg_region_lat)

site_order <- regions %>%
  select(site_code, decimal_latitude) %>%
  arrange(decimal_latitude)

# for separate sf and nc
site_order2 <- regions %>%
  select(site_code, decimal_latitude) %>%
  arrange(decimal_latitude)

# region/site environmental data
region_environment <- read_csv(here(dataedna,
                                    '20251212_environment_region.csv')) %>%
  select(!avg_region_lat) 

site_environment <- read_csv(here(dataedna,
                                    '20251212_environment_site.csv')) 

# species list
edna_peco <- read_csv(here('processeddata', 'peco', '2021-24_edna',
                             '20251113_peco-combined_12s_asvmatrix_fish.csv'))[-1] %>%
  filter(rank == 'species') %>%
  # remove below threshold
  filter(relabund_vst_taxa > 1) %>%
  # problematic sample
  filter(!(sample_id %in% c('pecoe-0207')))
  
sti_obis <- read_csv(here('rawdata', 'bigdata', 'obis_cti',
                          '20251212_sti_errdap_pathfinder.csv')) %>%
  # match edna
  rename(found_taxa = scientific_name) 
```


```{r cti and descriptive plots}
cti_peco <- edna_peco %>%
  left_join(sti_obis) %>%
  filter(!is.na(max_temp)) %>%
  # temporary until I merge [1]
  janitor::remove_empty() %>%
  group_by(site_code, year) %>%
  # weighted mean and SD from matrixStats package
  summarise(cti = weightedMean(sti_value, relabund_vst_taxa),
            # 95th percentile
            tbiasmax = weightedMean(temp_95, relabund_vst_taxa),
            tbiasmin = weightedMean(temp_05, relabund_vst_taxa)) %>%
  ungroup() %>%
  left_join(regions) %>%
  select(!c(decimal_latitude, decimal_longitude, samples)) %>%
  distinct() %>%
  mutate(region_name2 = factor(region_name, levels = region_order$region_name)) %>%
  left_join(site_order)

ggplot(cti_peco) +
  geom_boxplot(aes(y = cti, fill = as.factor(year))) +
  scale_fill_manual(values = c('#015B58FF', '#2C6184FF', '#89689DFF', '#BA7999FF')) +
  facet_wrap(~region_name2) +
  labs(fill = NULL, y = 'Degrees C', title = 'Thermal affinity of the community, by region') +
  theme_bw() +
  theme(axis.text.x = element_blank(),
        legend.position = 'bottom',
        panel.grid.minor = element_blank())

ggsave(here(plotout, paste0(datefield, 'cti_year-region.png')))

## cti vs summer temps

cti_environment <- cti_peco %>%
  left_join(region_temps) %>%
  mutate(sitegroup = fct_reorder(as_factor(site_code), year, .fun = first))

cti_environment_site <- cti_peco %>%
  left_join(site_temps) %>%
  #left_join(site_environment) #%>%
  group_by(region_name) %>%
  mutate(region_last5_meansst = mean(sst_mean, na.rm = TRUE),
         region_last5_maxsst = max(sst_max, na.rm = TRUE),
         region_last5_minsst = min(sst_min, na.rm = TRUE),
         region_last5_temp95 = mean(site_temp95, na.rm = TRUE),
         region_last5_temp75 = mean(site_temp75, na.rm = TRUE)) %>%
  ungroup() %>%
  group_by(site_code) %>%
  mutate(site_last5_meansst = mean(sst_mean, na.rm = TRUE),
         site_last5_maxsst = max(sst_max, na.rm = TRUE),
         site_last5_minsst = min(sst_min, na.rm = TRUE),
         site_last5_temp95 = mean(site_temp95, na.rm = TRUE),
         site_last5_temp75 = mean(site_temp75, na.rm = TRUE))%>%
  ungroup()

ggplot(cti_environment) +
  geom_point(aes(x = sst_mean, 
                y = cti,
                color = region_label,
                alpha = year)) +
    scale_color_manual(values = pal_2or) +
  geom_path(aes(x = sst_mean, y = cti,
                group = sitegroup
                ),
            alpha = .2)+
    labs(color = NULL,x = 'Mean summer SST', y = 'Thermal affinity of the community') +
  theme_bw() +
  theme(legend.position = 'none',
        panel.grid.minor = element_blank())

ggsave(here(plotout, paste0(datefield, 'ctivssst_bysite.png')),
        height = 2000,
       width = 3000,
       unit = 'px')


ggplot(cti_environment) +
  geom_point(aes(x = sst_mean, 
                y = cti,
                group = year,
                color = as.factor(year))) +
  scale_color_manual(values = c('#015B58FF', '#2C6184FF', '#89689DFF', '#BA7999FF')) +
  facet_wrap('region_name', scales = 'free') +
    labs(color = NULL,x = 'Mean summer SST, by region', y = 'Thermal affinity of the community') +
  theme_bw() +
  theme(legend.position = 'none',
        panel.grid.minor = element_blank())

ggsave(here(plotout, paste0(datefield, 'ctivssst_byyear_facet-region.png')),
        height = 2000,
       width = 3000,
       unit = 'px')


ggplot(cti_environment_site) +
  geom_point(aes(x = sst_mean, 
                y = cti,
                group = year,
                color = as.factor(year))) +
  scale_color_manual(values = c('#015B58FF', '#2C6184FF', '#89689DFF', '#BA7999FF')) +
  facet_wrap('region_name') +
    labs(color = NULL,x = 'Mean summer SST, by site', y = 'Thermal affinity of the community') +
  theme_bw() +
  theme(legend.position = 'none',
        panel.grid.minor = element_blank())

ggsave(here(plotout, paste0(datefield, 'ctivssst_by-site-year_facet-region.png')),
        height = 2000,
       width = 3000,
       unit = 'px')

ggplot(cti_environment) +
  geom_point(aes(x = year, 
                y = cti,
                color = region_label,
                alpha = year)) +
    scale_color_manual(values = pal_2or) +
  geom_path(aes(x = year, y = cti,
                group = sitegroup
                ),
            alpha = .2)+
  facet_wrap('region_name')+
  #geom_segment(aes(xend = ))
    labs(color = NULL,x = 'Year', y = 'Thermal affinity of the community') +
  theme_bw() +
  theme(legend.position = 'none',
        panel.grid.minor = element_blank())

ggsave(here(plotout, paste0(datefield, 'ctiyear_bysite_facetregion.png')),
        height = 2000,
       width = 3000,
       unit = 'px')

```

# TBias Max

Realized upper thermal limit

```{r tbiasmax}
# STI
sti_peco <- edna_peco %>%
  select(!c(decimal_latitude, decimal_longitude,
            extraction_blank, library,
            seagrass_presence, seagrass_notes, describe_transect,
            notes, collection_time_24h, notes_about_sample,
            extraction_notes, organization_participants, reads_adjust,
            filtration_comments, dna_extraction_date, biological_observations,
            collection_method, treatment, evalue, identity_percentage,
            relabund_wis_taxa, relabund_wis_motu, pcr_blank, 
            #bsaredo, lab_notes, 
            reads_adjust_fieldlab, reads_raw, reads_adjust_field,
            reads_adjust_lab, kingdom, phylum, rain, asv)) %>%
  left_join(sti_obis) %>%
  filter(!is.na(max_temp)) %>%
  # temporary until I merge [1]
  janitor::remove_empty() %>%
  left_join(regions) %>%
  select(!c(decimal_latitude, decimal_longitude, samples, avg_region_lat,
            sites, region_code_label, region_code, region_lat_name)) %>%
  distinct() %>%
  relocate(sti_value, region_label)
  
sti_environment <- sti_peco %>%
  left_join(site_temps) %>%
    # fill in with means if NA
  group_by(region_label, year) %>%
  mutate(region_mean = mean(sst_mean, na.rm = TRUE)) %>%
  ungroup() %>%
    # fill in with means if NA
  group_by(region_label, year) %>%
  mutate(region_mean = mean(sst_mean, na.rm = TRUE),
         region_95 = mean(site_temp95, na.rm = TRUE),
         region_75 = mean(site_temp75, na.rm = TRUE),
         region_05 = mean(site_temp05, na.rm = TRUE)) %>%
  ungroup() %>%
  mutate(sst_mean = coalesce(sst_mean, region_mean),
         site_temp95 = coalesce(site_temp95, region_95),
         site_temp75 = coalesce(site_temp75, region_75),
         site_temp05 = coalesce(site_temp05, region_05)) %>%
  select(!c(region_95, region_75, region_05, region_mean,
            site_temp90, site_temp25, site_temp10))


# sti_peco <- edna_peco %>%
#   select(!c(region_code, decimal_latitude, decimal_longitude,
#             region_code_label)) %>%
#   left_join(sti_obis) %>%
#   filter(!is.na(max_temp)) %>%
#   # temporary until I merge [1]
#   janitor::remove_empty() %>%
#   left_join(regions) %>%
#   select(!c(decimal_latitude, decimal_longitude, samples,
#             avg_region_lat, sites)) %>%
#   distinct() %>%
#   relocate(sti_value, region_label, seq_method)

ggplot()+
  geom_point(data = sti_peco,
               aes(y=sti_value,
                   x= factor(site_code, levels = site_order$site_code),
                  color = region_label),
               alpha = .3) +
    geom_point(data = cti_environment_site,
             aes(x = factor(site_code, levels = site_order$site_code),
                y = cti),
             shape = 23,
             fill = 'red') +
  scale_color_manual(values = pal_2or) +
  facet_wrap('year') +
  labs(color = NULL,x = 'Site', y = 'Thermal affinity | of the community') +
  theme_bw() +
  theme(axis.text.x = element_blank(),
        legend.position = 'none',
        panel.grid.minor = element_blank())


ggsave(here(plotout, paste0(datefield, 'sticti_bysite_facet-year_scatter.png')),
        height = 1750,
       width = 6500,
       unit = 'px')

ggplot()+
  geom_point(data = sti_peco,
               aes(x=sti_value,
                   y= factor(site_code, levels = site_order$site_code),
                  color = region_label,
                  alpha = relabund_vst_taxa)) +
    geom_point(data = cti_environment_site,
             aes(y = factor(site_code, levels = site_order$site_code),
                x = cti),
             shape = 23,
             fill = 'red') +
  scale_color_manual(values = pal_2or) +
  facet_wrap('year', nrow = 1) +
  labs(color = NULL,x = 'Site', y = 'Thermal affinity | of the community') +
  theme_bw() +
  theme(axis.text.x = element_blank(),
        legend.position = 'none',
        panel.grid.minor = element_blank())


ggsave(here(plotout, paste0(datefield, 'sticti_bysite_facet-year_scatter-alpha.pdf')),
        height = 10,
       width = 8,
       unit = 'in')


ggplot()+
  geom_point(data = sti_peco,
               aes(y=temp_05,
                   x= factor(site_code, levels = site_order$site_code),
                  color = region_label,
                  alpha = relabund_vst_taxa)) +
    geom_point(data = cti_environment_site,
             aes(x = factor(site_code, levels = site_order$site_code),
                y = tbiasmin),
             shape = 23,
             fill = 'red') +
  scale_color_manual(values = pal_2or) +
  facet_wrap('year') +
  labs(color = NULL,x = 'Site', y = 'Species-05 | TBiasMin') +
  theme_bw() +
  theme(axis.text.x = element_blank(),
        legend.position = 'none',
        panel.grid.minor = element_blank())


ggsave(here(plotout, paste0(datefield, 's05tbiasmin_bysite_facet-year_scatter-alpha.png')),
        height = 2500,
       width = 6500,
       unit = 'px')


```

# Compare thermal affinity and environment

```{r}
cti_environment_site_distinct <- cti_environment_site %>%
  select(site_code,decimal_latitude, region_label, site_last5_meansst,
         site_last5_temp75, site_last5_temp95) %>%
  distinct()

cti_environment_region_distinct <- cti_environment_site %>%
  select(site_code, region_label, region_last5_meansst,
         region_last5_temp75, region_last5_temp95) %>%
  distinct()

sti_peco %>%
  select(site_code, temp_95, region_label, found_taxa) %>%
  distinct()%>%
  left_join(cti_environment_site_distinct) %>%
  mutate(below_mean = ifelse(temp_95 < site_last5_meansst, 'below', 'above')) %>%
  ggplot()+
  geom_point(aes(y=temp_95,
                   x= factor(site_code, levels = site_order$site_code),
                  color = region_label,
                  alpha = below_mean
                 )) +
  scale_alpha_manual(values = c(.5,1))+
        geom_point(data = cti_environment_site_distinct,
                 aes(x = factor(site_code, levels = site_order2$site_code),
                y = site_last5_meansst),
             shape = 13,
             size = 3,
             fill = 'white',
             alpha = .5) +
  scale_color_manual(values = pal_2or) +
  coord_flip() +
  #facet_wrap('year') +
  labs(color = NULL,x = NULL, y = 'Species-95 | Mean summer SST') +
  theme_bw() +
  theme(#axis.text.x = element_blank(),
        legend.position = 'none',
        panel.grid.minor = element_blank())

ggsave(here(plotout, paste0(datefield,
                            's95-mean_bysite_scatter_vertical.pdf')),
        height = 12,
       width = 6,
       unit = 'in')

sti_peco %>%
  select(site_code, temp_05, region_label, found_taxa) %>%
  distinct()%>%
  left_join(cti_environment_site_distinct) %>%
  mutate(below_mean = ifelse(temp_05 < site_last5_meansst, 'below', 'above')) %>%
  ggplot()+
  geom_point(aes(y=temp_05,
                   x= factor(site_code, levels = site_order$site_code),
                  color = region_label,
                  alpha = below_mean
                 )) +
  scale_alpha_manual(values = c(.5,1))+
        geom_point(data = cti_environment_site_distinct,
                 aes(x = factor(site_code, levels = site_order2$site_code),
                y = site_last5_meansst),
             shape = 13,
             size = 3,
             fill = 'white',
             alpha = .5) +
  scale_color_manual(values = pal_2or) +
  coord_flip() +
  labs(color = NULL,x = NULL, y = 'Species-05 | Mean summer SST') +
  theme_bw() +
  theme(legend.position = 'none',
        panel.grid.minor = element_blank())

ggsave(here(plotout, paste0(datefield,
                            's05-mean_bysite_scatter_vertical.pdf')),
        height = 12,
       width = 6,
       unit = 'in')


```

```{r prsentation version of 95}

testing <- sti_peco %>%
  select(site_code, temp_95, region_label, found_taxa) %>%
  distinct()%>%
  left_join(cti_environment_site_distinct) %>%
  mutate(below_mean = ifelse(temp_95 < site_last5_meansst, 'below', 'above')) 

sti_peco %>%
  select(site_code, temp_95, region_label, found_taxa) %>%
  distinct()%>%
  left_join(cti_environment_site_distinct) %>%
  mutate(below_mean = case_when(is.na(site_last5_meansst) ~ 'z',
                                temp_95 < site_last5_meansst ~ 'below',
                                temp_95 > site_last5_meansst ~ 'above')) %>%
  ggplot()+
  geom_point(aes(y=temp_95,
                   x= factor(site_code, levels = site_order$site_code),
                  color = region_label,
                  alpha = below_mean
                 )) +
  scale_alpha_manual(values = c(.3,1, .3))+
        geom_point(data = cti_environment_site_distinct,
                 aes(x = factor(site_code, levels = site_order2$site_code),
                y = site_last5_meansst),
             shape = 13,
             size = 3,
             fill = 'white',
             alpha = .5) +
  scale_color_manual(values = pal_2or) +
  coord_flip() +
  #facet_wrap('year') +
  labs(color = NULL,x = NULL, y = 'Species-95 | Mean summer SST') +
  theme_bw() +
  theme(#axis.text.y = element_blank(),
        legend.position = 'none',
        panel.grid.minor = element_blank())

ggsave(here(plotout, paste0(datefield,
                            's95-mean_bysite_scatter_vertical-presentation.png')),
        height = 12,
       width = 6,
       unit = 'in')
```




```{r interactive version of 95}
interactive <- sti_peco %>%
  select(site_code, temp_95, region_label, region_name, found_taxa, common_name, location_name) %>%
  distinct() %>%
  ggplot()+
  geom_point(aes(y=temp_95,
                   x= factor(site_code, levels = site_order$site_code),
                 text = paste0(found_taxa, ", known as ", common_name,
                               ", from ", "\n", location_name, ", ", region_label,
                               " has an STI of ", temp_95),
                  color = region_label#,
                  #alpha = relabund_vst_taxa
                 )) +
    geom_point(data = cti_environment_site_distinct,
               aes(x = factor(site_code, levels = site_order$site_code),
                y = site_last5_temp95),
             shape = 24,
             size = 3,
             fill = '#630D22FF',
             alpha = .6) +
      geom_point(data = cti_environment_site_distinct,
                 aes(x = factor(site_code, 
                                levels = site_order$site_code),
                y = site_last5_temp75),
             shape = 24,
             size = 3,
             fill = '#AF3126FF',
             alpha = .5) +
        geom_point(data = cti_environment_site_distinct,
                 aes(x = factor(site_code, levels = site_order$site_code),
                y = site_last5_meansst),
             shape = 24,
             size = 3,
             fill = 'white',
             alpha = .5) +
  scale_color_manual(values = pal_2or) +
  #facet_wrap('year') +
  labs(color = NULL,x = 'Site', y = 'Species-95 | Region-95-75-mean') +
  theme_bw() +
  theme(axis.text.x = element_blank(),
        legend.position = 'none',
        panel.grid.minor = element_blank())


interactive  
#make interactive 
interactive2 <- plotly::ggplotly(interactive, tooltip = c('text')) 
interactive2



htmlwidgets::saveWidget(widget = interactive2,
                        file = '20251111_ctsm_interactive.html')
```

# Thermal stats by species

Histogram of occurrence values with min-max-median marked

```{r byspecies loop}
splist <- unique(edna_peco$found_taxa)

common_key <- edna_peco %>%
  select(found_taxa, common_name) %>%
  distinct()

for(i in 1:length(splist)){
  target_sp <- splist[i]
  
  sti_unprocessed <- read_csv(here('rawdata', 'bigdata', 'obis_cti',
                          '20250803_sti_errdap_pathfinder-unprocessed.csv')) %>%
    rename(found_taxa = scientific_name) %>%
    filter(found_taxa == target_sp) %>%
    left_join(common_key)
  
  target_sp_common <- sti_unprocessed %>%
    select(common_name) %>%
    distinct()
  
  sti_target <- sti_unprocessed %>%
        filter(!is.na(sst) | !is.na(sst_n)) %>%
    pivot_longer(cols = c('sst', 'sst_n'),
               names_to = 'type_sst',
               values_to = 'sst') %>%
    filter(!is.na(sst)) %>%
      summarise(max_temp = max(sst),
            min_temp = min(sst),
            temp_95 = quantile(sst, probs = .95),
            temp_90 = quantile(sst, probs = .9),
            temp_10 = quantile(sst, probs = .1),
            temp_05 = quantile(sst, probs = .05),
            # sti is median of averages
            sti_value = median(sst)) 
  
  sti_unprocessed %>%
            filter(!is.na(sst) | !is.na(sst_n)) %>%
    pivot_longer(cols = c('sst', 'sst_n'),
               names_to = 'type_sst',
               values_to = 'sst') %>%
    filter(!is.na(sst)) %>%
  ggplot() +
  geom_histogram(aes(x = sst)) +
    geom_vline(aes(xintercept = median(sst)), 
               color = '#4D94BAFF') +
    geom_vline(aes(xintercept = sti_target$temp_95),
                   color = '#C9785CFF') +
    geom_vline(aes(xintercept = sti_target$temp_05), 
                 color = '#8EE5EE') +
  scale_x_continuous(limits = c(-5,40)) +
  theme_bw() +
  labs(title = paste0(target_sp_common$common_name)) +
  theme(axis.title.y = element_blank(),
        panel.grid = element_blank(),
        legend.position = 'none')
  
  ggsave(filename = here(plotout, 'splevel', paste0(datefield, 'thermalstats_',
                                                    target_sp_common$common_name, '.pdf')),
       device = 'pdf', height = 2, width = 5, units = 'in')
}
```


## species and region stats
```{r stats for paper}
# north of point conception affinities
sti_peco %>%
  filter(!(region_name %in% c('CA_SD', 'CA_LA'))) %>%
  select(found_taxa, common_name, sti_value, temp_95, temp_05) %>%
  distinct() %>%
  filter(temp_05 > 14.6)

sti_peco %>%
  filter((region_name %in% c('CA_SD', 'CA_LA'))) %>%
  select(found_taxa, common_name, sti_value, temp_95, temp_05) %>%
  distinct() %>%
  filter(temp_05 > 14.6)

sti_peco %>%
  filter((region_name %in% c('CA_SD', 'CA_LA'))) %>%
  select(found_taxa, common_name, sti_value, temp_95, temp_05, min_temp) %>%
  distinct() %>%
  filter(min_temp > 14.6)

# morro bay mean 14.6C
region_environment %>%
  group_by(region_name) %>%
  mutate(mean_region = mean(sst_mean)) %>%
  ungroup() %>%
  select(region_name, mean_region) %>%
  distinct()

# north of point conception communities
cti_peco %>%
  filter(!(region_name %in% c('CA_SD', 'CA_LA'))) %>%
  #select(cti) %>%
  distinct() %>%
  summarise(minimum = min(cti),
            maximum = max(cti),
            sd_cti = sd(cti),
            mean_cti = mean(cti))

cti_peco %>%
  filter(region_name %in% c('CA_SD', 'CA_LA')) %>%
  #select(cti) %>%
  distinct() %>%
  summarise(minimum = min(cti),
            maximum = max(cti),
            sd_cti = sd(cti),
            mean_cti = mean(cti))
```

## Which fish are most in 'danger'?

```{r whichfish}
whichfish <- sti_peco %>%
  select(site_code, temp_95, sti_value, region_label, found_taxa, common_name) %>%
  distinct() %>% 
  left_join(cti_environment_site_distinct) %>%
  #filter(!region_last5_temp95 == 'NaN') %>%
  mutate(dangerlevel = case_when(temp_95 < site_last5_meansst ~ '4 highest',
                                 temp_95 < site_last5_temp75 ~ '3 high',
                                 temp_95 < site_last5_temp95 ~ '2 uncomfortable',
                                 TRUE ~ '1 safe')) %>%
  relocate(found_taxa, common_name, dangerlevel) %>%
  select(!c(site_code)) %>%
  distinct()


write_csv(whichfish, here(dataedna, '20251111_fishatrisk.csv'))

fish_for_table <- sti_peco %>%
  select(site_code, temp_95, sti_value, region_label, found_taxa, common_name) %>%
  distinct() %>% 
  left_join(cti_environment_site_distinct) %>%
  mutate(dangerlevel = case_when(temp_95 < site_last5_meansst ~ '4 highest',
                                 temp_95 < site_last5_temp75 ~ '3 high',
                                 temp_95 < site_last5_temp95 ~ '2 uncomfortable',
                                 TRUE ~ '1 safe')) %>%
  filter(dangerlevel == '4 highest') %>%
  group_by(region_label) %>%
  mutate(region_mean_meansst = mean(site_last5_meansst)) %>%
  ungroup() %>%
    relocate(found_taxa, common_name, temp_95, region_mean_meansst) %>%
  select(!c(dangerlevel, sti_value, site_code, site_last5_meansst,
            site_last5_temp75, site_last5_temp95, decimal_latitude)) %>%
  distinct() %>%
  left_join(region_order) %>%
  arrange(region_lat_name, found_taxa) %>%
  select(!c(region_lat_name, avg_region_lat)) %>%
  mutate(temp_95 = round(temp_95, digits = 4),
         region_mean_meansst = round(region_mean_meansst, digits = 4))
  

write_csv(fish_for_table, here(dataedna, paste0(datefield, 'fishatrisk-table.csv')))

```

## Which sites have the most vulnerable species?
```{r site vulnerable score}

site_vulnerable <- sti_peco %>%
  select(site_code, location_name, temp_95, sti_value, region_label, found_taxa) %>%
  distinct() %>% 
  left_join(cti_environment_site_distinct) %>%
  add_count(site_code, name = 'nsp_site') %>%
  mutate(vulnerable_sp = ifelse(temp_95 < site_last5_meansst, 'x', NA_character_)) %>%
  add_count(site_code, vulnerable_sp, name = 'nsp_site_vulnerable') %>%
  mutate(nsp_site_vulnerable = 
           ifelse(is.na(vulnerable_sp), NA_character_, nsp_site_vulnerable))

site_score <- site_vulnerable %>%
  select(decimal_latitude, region_label, location_name, nsp_site, nsp_site_vulnerable) %>%
  distinct() %>%
  filter(!is.na(nsp_site_vulnerable)) %>%
  mutate(site_vulnerable_perc = round(
           (as.numeric(nsp_site_vulnerable) / nsp_site) * 100, digits = 1))


write_csv(site_score, here(plotout, paste0(datefield, 'site-level_vulnerability-score.csv')))

region_vulnerable <- sti_peco %>%
  select(temp_95, sti_value, region_label, found_taxa) %>%
  distinct() %>% 
  left_join(cti_environment_region_distinct) %>% 
  select(!site_code) %>%
  distinct() %>%
  add_count(region_label, name = 'nsp_region') %>%
  mutate(vulnerable_sp = ifelse(temp_95 < region_last5_meansst, 'x', NA_character_)) %>%
  add_count(region_label, vulnerable_sp, name = 'nsp_region_vulnerable') %>%
  mutate(nsp_region_vulnerable = 
           ifelse(is.na(vulnerable_sp), NA_character_, nsp_region_vulnerable))

region_score <- region_vulnerable %>%
  select(region_label, nsp_region, nsp_region_vulnerable) %>%
  distinct() %>%
  filter(!is.na(nsp_region_vulnerable)) %>%
  mutate(region_vulnerable_perc = round(
           (as.numeric(nsp_region_vulnerable) / nsp_region) * 100, digits = 1))

# how many sp south of Pt C
sti_peco %>%
  filter(region_name %in% c('CA_LA', 'CA_SD')) %>%
  select(temp_95, sti_value, region_label, found_taxa) %>%
  distinct() %>% 
  left_join(cti_environment_region_distinct) %>% 
  select(!site_code) %>%
  distinct() %>%
  mutate(nsp_region = length(unique(found_taxa))) %>%
  mutate(vulnerable_sp = ifelse(temp_95 < region_last5_meansst, 'x', NA_character_)) %>%
  filter(!is.na(vulnerable_sp)) %>%
  mutate(nsp_region_vulnerable = length(unique(found_taxa))) %>%
  #add_count(region_label, vulnerable_sp, name = 'nsp_region_vulnerable') %>%
  select(region_label, nsp_region, nsp_region_vulnerable) %>%
  distinct() %>%
  mutate(region_vulnerable_perc = round(
           (as.numeric(nsp_region_vulnerable) / nsp_region) * 100, digits = 1))
```

## Identify cold and warm affinities

## which decline

```{r warm-affinity}
# shape palette
shapeyear <- c('2021' = 15,
               '2022' = 16,
               '2023' = 17,
               '2024' = 18)

# what are the quantiles of stis
sti_quantiles <- sti_peco %>%
  select(sti_value, found_taxa, common_name) %>%
  distinct() %>%
  summarize(upper10 = quantile(sti_value, probs = .90),
            upper20 = quantile(sti_value, probs = .80),
            upper25 = quantile(sti_value, probs = .75),
            upper50 = quantile(sti_value, probs = .5),
            lower25 = quantile(sti_value, probs = .25),
            lower10 = quantile(sti_value, probs = .1))


# what is the distribution of stis
sti_peco %>%
  select(sti_value, found_taxa, common_name) %>%
  distinct() %>%
  ggplot() +
  geom_histogram(aes(x = sti_value),
                 binwidth = .5) +
  #geom_vline(xintercept = sti_quantiles$upper20) +
  geom_vline(xintercept = 20) +
  labs(x = 'Thermal affinity', y = NULL,
       title = 'Species in PECO') +
  theme_bw() +
  theme(panel.grid = element_blank())

ggsave(here(plotout, paste0(datefield, 'thermal-affinity_histogram.pdf')))


affinity_warm <- sti_peco %>%
  # between top 2 gaps in histogram
  filter(sti_value >= 20) %>%
  select(c(sti_value, found_taxa, common_name, sample_id, relabund_vst_taxa,
           year, site_code, region_name, region_label)) %>%
  distinct() %>%
  #left_join(site_environment) %>%
    left_join(site_temps) %>%
    # fill in with means if NA
  group_by(region_label, year) %>%
  mutate(region_mean = mean(sst_mean, na.rm = TRUE)) %>%
  ungroup() %>%
    # fill in with means if NA
  group_by(region_label, year) %>%
  mutate(region_mean = mean(sst_mean, na.rm = TRUE),
         region_95 = mean(site_temp95, na.rm = TRUE),
         region_75 = mean(site_temp75, na.rm = TRUE),
         region_05 = mean(site_temp05, na.rm = TRUE)) %>%
  ungroup() %>%
  mutate(sst_mean = coalesce(sst_mean, region_mean),
         site_temp95 = coalesce(site_temp95, region_95),
         site_temp75 = coalesce(site_temp75, region_75),
         site_temp05 = coalesce(site_temp05, region_05)) %>%
  select(!c(region_95, region_75, region_05, region_mean,
            site_temp90, site_temp25, site_temp10))

affinity_cold <- sti_peco %>%
  # bottom of histogram
  filter(sti_value < 20) %>%
    select(c(sti_value, found_taxa, common_name, sample_id, relabund_vst_taxa,
           year, site_code, region_name, region_label)) %>%
  distinct() %>%
  #left_join(site_environment) %>%
    left_join(site_temps) %>%
    # fill in with means if NA
  group_by(region_label, year) %>%
  mutate(region_mean = mean(sst_mean, na.rm = TRUE)) %>%
  ungroup() %>%
    # fill in with means if NA
  group_by(region_label, year) %>%
  mutate(region_mean = mean(sst_mean, na.rm = TRUE),
         region_95 = mean(site_temp95, na.rm = TRUE),
         region_75 = mean(site_temp75, na.rm = TRUE),
         region_05 = mean(site_temp05, na.rm = TRUE)) %>%
  ungroup() %>%
  mutate(sst_mean = coalesce(sst_mean, region_mean),
         site_temp95 = coalesce(site_temp95, region_95),
         site_temp75 = coalesce(site_temp75, region_75),
         site_temp05 = coalesce(site_temp05, region_05)) %>%
  select(!c(region_95, region_75, region_05, region_mean,
            site_temp90, site_temp25, site_temp10))

# all regions
affinity_warm %>%
  ggplot() +
  geom_point(aes(y = relabund_vst_taxa,
                 x = sst_mean,
                 colour = region_label,
                 shape = as.factor(year)
                 )) +
  scale_color_manual(values = pal_2or) +
      scale_shape_manual(values = shapeyear)+
  labs(title = 'warm affinity') +
  facet_wrap('region_label', scales = 'free') +
      scale_y_continuous(limits = c(0,25)) +
  theme_bw() + 
  theme(legend.position = 'none')

ggsave(here(plotout, paste0(datefield, 'vst-sst_warmaffinity.png')))

affinity_cold %>%
  ggplot() +
  geom_point(aes(y = relabund_vst_taxa,
                 x = sst_mean,
                 colour = region_label,
                 shape = as.factor(year)
                 )) +
  scale_color_manual(values = pal_2or) +
      scale_shape_manual(values = shapeyear)+
  labs(title = 'cool affinity') +
  facet_wrap('region_label', scales = 'free') +
      scale_y_continuous(limits = c(0,25)) +
  theme_bw() + 
  theme(legend.position = 'none')

ggsave(here(plotout, paste0(datefield, 'vst-sst_coolaffinity.png')))

# southern california
affinity_warm %>%
  filter(region_name %in% c('CA_SD', 'CA_LA', 'CA_MB')) %>%
  ggplot() +
  geom_point(aes(y = relabund_vst_taxa,
                 x = sst_mean,
                 colour = region_label,
                 shape = as.factor(year)
                 )) +
  scale_color_manual(values = pal_2or) +
      scale_shape_manual(values = shapeyear)+
  scale_y_continuous(limits = c(0,25)) +
  labs(title = 'warm affinity, southern cali') +
  facet_wrap('region_label', scales = 'free') +
  theme_bw() + 
  theme(legend.position = 'none')

ggsave(here(plotout, paste0(datefield, 'vst-sst_warmaffinity-southerncali.png')))

affinity_cold %>%
  filter(region_name %in% c('CA_SD', 'CA_LA', 'CA_MB')) %>%
  ggplot() +
  geom_point(aes(y = relabund_vst_taxa,
                 x = sst_mean,
                 colour = region_label,
                 shape = as.factor(year)
                 )) +
  scale_color_manual(values = pal_2or) +
      scale_shape_manual(values = shapeyear)+
    scale_y_continuous(limits = c(0,25)) +
  labs(title = 'cool affinity, southern cali') +
  facet_wrap('region_label', scales = 'free') +
  theme_bw() + 
  theme(legend.position = 'none')

ggsave(here(plotout, paste0(datefield, 'vst-sst_coolaffinity-southerncali.png')))

# morro bay only
affinity_warm %>%
  filter(region_name %in% c('CA_MB')) %>%
  ggplot() +
  geom_point(aes(y = relabund_vst_taxa,
                 x = sst_mean,
                 colour = region_label,
                 shape = as.factor(year)
                 )) +
  scale_color_manual(values = pal_2or) +
      scale_shape_manual(values = shapeyear)+
  scale_y_continuous(limits = c(0,25)) +
  labs(title = 'warm affinity',
       x = 'Mean summer SST',
       y = 'Relative abundance') +
  facet_wrap('region_label', scales = 'free') +
  theme_bw() + 
  theme(legend.position = 'none')

ggsave(here(plotout, paste0(datefield, 'vst-sst_warmaffinity-ca-mb.pdf')),
       height = 6,
       width = 3,
       units = 'in')

affinity_cold %>%
  filter(region_name %in% c('CA_MB')) %>%
  ggplot() +
  geom_point(aes(y = relabund_vst_taxa,
                 x = sst_mean,
                 colour = region_label,
                 shape = as.factor(year)
                 )) +
  scale_color_manual(values = pal_2or) +
    scale_y_continuous(limits = c(0,25)) +
      scale_shape_manual(values = shapeyear)+
  labs(title = 'cool affinity',
       x = 'Mean summer SST',
       y = 'Relative abundance') +
  facet_wrap('region_label', scales = 'free') +
  theme_bw() + 
  theme(legend.position = 'none')

ggsave(here(plotout, paste0(datefield, 'vst-sst_coolaffinity-ca-mb.pdf')),
       height = 6,
       width = 3,
       units = 'in')

# morro bay only
affinity_warm %>%
  filter(region_name %in% c('CA_NC')) %>%
  ggplot() +
  geom_point(aes(y = relabund_vst_taxa,
                 x = sst_mean,
                 colour = region_label,
                 shape = as.factor(year)
                 )) +
  scale_color_manual(values = pal_2or) +
    scale_shape_manual(values = shapeyear)+
  scale_y_continuous(limits = c(0,25)) +
  labs(title = 'warm affinity',
       x = 'Mean summer SST',
       y = 'Relative abundance') +
  facet_wrap('region_label', scales = 'free') +
  theme_bw() + 
  theme(legend.position = 'none')

ggsave(here(plotout, paste0(datefield, 'vst-sst_warmaffinity-ca-bb.pdf')),
       height = 6,
       width = 3,
       units = 'in')

affinity_cold %>%
  filter(region_name %in% c('CA_NC')) %>%
  ggplot() +
  geom_point(aes(y = relabund_vst_taxa,
                 x = sst_mean,
                 colour = region_label,
                 shape = as.factor(year)
                 )) +
  scale_color_manual(values = pal_2or) +
  scale_shape_manual(values = shapeyear)+
    scale_y_continuous(limits = c(0,25)) +
  labs(title = 'cool affinity',
       x = 'Mean summer SST',
       y = 'Relative abundance') +
  facet_wrap('region_label', scales = 'free') +
  theme_bw() + 
  theme(legend.position = 'none')

ggsave(here(plotout, paste0(datefield, 'vst-sst_coolaffinity-ca-bb.pdf')),
       height = 6,
       width = 3,
       units = 'in')
```





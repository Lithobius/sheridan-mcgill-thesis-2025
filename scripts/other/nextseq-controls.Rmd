---
title: "nextseq-controls"
author: "Kate Sheridan"
date: "`r Sys.Date()`"
output: html_document
---

Additionally, my original nextseq vs miseq comparisons were from a file that had both combined into one, this condensed script is from where I wanted to compare what happened if you only looked at nextseq and removed ASVs with low read counts in samples that shared an index.

This assumes you're working from a raw sequence table, so if you have data in a different format feel free to rewrite most of it, you just need the following columns to make the plot:
  - sample_id (names of samples)
  - reads_raw (reads for an ASV in that sample)
  - index1_number (generated by this script)
  - index2_number (generated by this script)
  If species annotations are included:
  - species (annotations)
  
  
```{r setup}
library(tidyverse)
library(janitor)
library(here)
library(ggpubr)

seqs_in <- here('processeddata', 'peco', 'nextseq_miseq')
dataedna <- here('processeddata', 'peco', '2021-24_edna')
plot_out <- here('output', 'nextseq_miseq')

datefield <- '20251125_'

pal_2or <- c("Juneau Region, Alaska" = "#00496F",
             "Southeast Alaska" = "#03587B",
             "Haida Gwaii, British Columbia" = "#076787",
             "Central Coast British Columbia" = "#0B7693",
             "North Vancouver Island, British Columbia" = "#0F85A0",
             "Inner Coast, British Columbia" = "#469989",
             "Pacific Rim Park, British Columbia" = "#7EAE73",
             "Puget Sound & Padilla Bay, Washington" = "#B5C25C",
             "Willapa Bay, Washington" = "#EDD746",
             "Yaquina Bay, Oregon" = "#EDC334",
             "Coos Bay, Oregon" = "#EDB123",
             "Humboldt Bay, California" = "#ED9E11",
             "Bodega Bay, California" = "#ED8B00",
             "San Francisco Bay, California" = "#E97809",
             "Morro Bay, California" = "#E56512",
             "Los Angeles, California" = "#E1531B",
             "San Diego region, California" = "#DD4124")
```

loadin

```{r}
mifish_edna <- read.csv(here(seqs_in,
                             '20240619_peco2022_12s_bothseqs_asvmatrix_fish.csv')) %>%
  rename(found_taxa = found_taxa_asv,
         rank = rank_asv,
         common_name = common_name_asv)

new_range <- mifish_edna %>%
  filter(rank == 'species') %>%
  select(found_taxa, common_name, decimal_latitude) %>%
  distinct() %>%
  group_by(found_taxa) %>%
  summarise(taxa_max = max(decimal_latitude), taxa_mean = mean(decimal_latitude),
            taxa_median = median(decimal_latitude), taxa_min = min(decimal_latitude)) %>%
  ungroup %>%
  arrange(taxa_mean)

peco_index <- read_csv(here(seqs_in, 'index_list.csv')) %>%
  clean_names() %>%
  mutate(sample_id = tolower(sample_id))

index_numbers <- peco_index %>%
  mutate(index1_number = as.numeric(factor(index))) %>%
  mutate(index2_number = as.numeric(factor(index2)))

demulitplex_stats <- read_csv(here(seqs_in, 'Demultiplex_Stats.csv')) %>%
  clean_names() %>%
  mutate(sample_id = tolower(sample_id))


regions <- read_csv(here(dataedna, '20251113_peco_region-name-plotting.csv'))[-1] %>%
  rename(region_label = region_name_label) 

region_2022 <- regions %>%
  select(region_name, region_label) %>%
  distinct()

region_order <- regions %>%
  select(region_lat_name, region_name, region_label, avg_region_lat) %>% 
  distinct() %>%
  arrange(-avg_region_lat)

site_order <- regions %>%
  select(site_code, decimal_latitude) %>%
  arrange(decimal_latitude)
```

# compare next and miseq

```{r}
nextseq_samples <- mifish_edna %>%
  filter(method == 'nextseq') %>%
  select(sample_id) %>%
  distinct() %>%
  mutate(sample_id = str_remove_all(sample_id, "_nextseq"))

in_nextseq <- mifish_edna %>%
  filter(rank == "species") %>%
  filter(!(ctrl_field0 == "yes")) %>%
  mutate(in_nextseq = case_when(sample_id %in% nextseq_samples$sample_id & method == "miseq" ~ "yes")) %>%
  filter(!is.na(in_nextseq)) %>%
  mutate(method = "miseq_in_nextseq") %>%
  select(found_taxa, common_name, region_name, site_code, method) %>%
  distinct() %>%
  add_count(region_name, found_taxa, name = 'n_sites')

miseqonly <- mifish_edna %>%
  filter(rank == "species") %>%
  filter(!(ctrl_field0 == "yes")) %>%
  mutate(in_nextseq = case_when(sample_id %in% nextseq_samples$sample_id & method == "miseq" ~ "yes",
                                method == "nextseq" ~ 'yes')) %>%
  filter(is.na(in_nextseq))

nextseqonly <- mifish_edna %>%
  filter(rank == "species") %>%
  filter(method == 'nextseq') %>%
  mutate(sample_id = str_remove_all(sample_id, "_nextseq")) %>%
  distinct()


bubble_plot_data <- mifish_edna %>%
  filter(rank == "species") %>%
  #filter(rank_asv == "species" & !is.na(common_name_asv)) %>%
  filter(!is.na(common_name)) %>%
  filter(!(ctrl_field0 == "yes")) %>%
  select(found_taxa, common_name, region_name, site_code, method) %>%
  distinct() %>%
  add_count(region_name, found_taxa, method, name = 'n_sites') %>%
  bind_rows(in_nextseq) %>%
  left_join(region_2022) 

bubble_plot_data %>%
  ggplot() +
  geom_point(aes(x = factor(found_taxa, levels = new_range$found_taxa), 
             y = factor(region_label, levels = region_order$region_label),
             size = 10 + n_sites,
             color = region_label)) +
  facet_wrap(~method, ncol=1)+
  scale_color_manual(values = pal_2or)+
  # keeps wanting to put california at the top
  scale_y_discrete(limits = rev) +
  # coord_cartesian is what lets us add the labels later
  coord_cartesian(clip = 'off') +
  theme_bw() +
  scale_x_discrete(drop=FALSE) +
  scale_size(guide = 'none') +
  scale_alpha(guide = 'none') +
  xlab("Fish identified to species") +
  theme(axis.title.y = element_blank(),
        axis.text.y = element_blank(),
        legend.position = 'none',
        #axis.title.x = element_blank(),
        axis.text.x = element_text(size = 6, angle = 60, hjust=1),
        plot.margin = unit(c(1,1,1,2), 'lines'),
        panel.grid = element_blank(),
        axis.ticks.y = element_blank())



ggsave(filename = here(plot_out, paste0(datefield, 'nextseq2022_comparision.pdf')),
       device = 'pdf', height = 8, width = 14)
```


# Indexing
```{r}
edna_compare_data <- mifish_edna %>%
  filter(rank == 'species') %>%
  filter(!(ctrl_field0 == "yes")) %>%
    mutate(in_nextseq = case_when(sample_id %in% nextseq_samples$sample_id & method == "miseq" ~ "yes",
                                method == "nextseq" ~ 'yes')) %>%
  filter(in_nextseq == "yes") %>%
  mutate(sample_id = str_remove_all(sample_id, "_nextseq")) %>%
  left_join(region_2022) %>%
  select(sample_id, asv_pa, found_taxa, common_name, region_label, site_code, method) %>%
  distinct() %>%
  left_join(index_numbers)

nextseq_index_data <- edna_compare_data %>%
  filter(method == 'nextseq') %>%
  select(sample_id, index, index2, index1_number, index2_number, region_label) %>%
  distinct()

ggplot(nextseq_index_data) +
  geom_point(aes(x = as.factor(index),
                 y = as.factor(index2),
                 color = region_label)) +
  scale_color_manual(values = pal_2or)+
  labs(x = "Index 1", y = "Index 2") +
  theme_bw() +
  theme(legend.position = 'none',
        axis.text.x = element_text(angle = 45, hjust = 1))

ggsave(here(plot_out, 'combinatorial_index.png'),
       device = 'png',
       width = 2000,
       height = 1500,
       unit = 'px')

ggsave(here(plot_out, 'combinatorial_index.pdf'),
       device = 'pdf',
       width = 8.5,
       height = 6,
       unit = 'in')


ggplot(nextseq_index_data) +
  geom_point(aes(x = index1_number,
                 y = index2_number,
                 color = region_label)) +
  scale_color_manual(values = pal_2or)+
  labs(x = "Index 1", y = "Index 2",
       title = 'PECO index by region') +
      scale_x_continuous(breaks = c(1:23)) +
  scale_y_continuous(breaks = c(1:16)) +
  theme_bw() +
  theme(legend.position = 'none',
        axis.text.x = element_text(angle = 45, hjust = 1),
        panel.grid.minor = element_blank())

ggsave(here(plot_out, 'combinatorial_index-bynum.png'),
       device = 'png',
       width = 2000,
       height = 1500,
       unit = 'px')
```

Fish that are now appearing further south in the 2022 NextSeq, and where their Fishbase ranges are:
Ophiodon elongatus = Alaska and as far south as Ensenada (better)
Liparis cyclopus = Alaska to Oregon (better)
Oncorhynchus keta = Alaska to San Diego (better)
Oncorhynchus tshawytscha = Alaska to San Joanquin and King rivers in California (not good)
Artedius lateralis = Alaska to Baja (better)
Lumpenus sagitta = Alaska to San Francisco (not good)
Lepidogobius lepidus = Northern BC to Baja (better)
Hydrolagus colliei = Alaska to Baha (better)

Fish that are now appearing further north in the 2022 NextSeq, and where their Fishbase ranges are:
Girella nigricans = Subtropical, south of San Francisco (not good)
Embiotoca jacksoni = Subtropical, South of Fort Bragg (not good)
Mugil cephalus = Cosmopolitan but mostly California and south (might be ok)
Leuresthes tenuis = Subtropical, south of Monterrey Bay (not good)
Seriola lalandi = Subtropical, but can be “British Columbia, Canada to Chile” (ok)
Anchoa delicatissima = Subtropical, south of Long Beach Harbor, California (not good) 

index comparison
based on : https://onlinelibrary.wiley.com/doi/10.1111/1755-0998.13745
row and column are tags, color is read number, shouldn't be horizontal or vertical

```{r}
further_north <- c("Girella nigricans", "Embiotoca jacksoni", "Mugil cephalus", 
                   "Leuresthes tenuis", "Seriola lalandi", "Anchoa delicatissima")

further_south <- c("Ophiodon elongatus", "Liparis cyclopus", "Oncorhynchus keta", 
                  "Oncorhynchus tshawytscha", "Artedius lateralis", 
                  "Lumpenus sagitta", "Lepidogobius lepidus", 
                  "Hydrolagus colliei")

further_north_bad <- c("Girella nigricans", "Embiotoca jacksoni", "Mugil cephalus", 
                   "Leuresthes tenuis", "Anchoa delicatissima")

further_south_bad <- c("Oncorhynchus tshawytscha",
                  "Lumpenus sagitta")

ns_pal <- c('bad' = 'black',
            'north' = 'grey60',
            'south' = 'grey60')

cdi_plot_data <- edna_compare_data %>%
  filter(method == 'nextseq') %>%
  select(sample_id, found_taxa, region_label, site_code) %>%
  left_join(peco_index) %>%
  mutate(further_south = case_when(found_taxa %in% further_south_bad ~ "bad",
                                   found_taxa %in% further_south ~ 'south')) %>%
  mutate(further_north = case_when(found_taxa %in% further_north_bad ~ "bad",
                                   found_taxa %in% further_north ~ 'north')) %>%
  select(!found_taxa) %>%
  distinct() %>%
  group_by(sample_id) %>%
  mutate(further_south = case_when(any(further_south %in% c('bad')) ~ 'bad',
                                   any(further_south %in% c('south')) ~ 'south')) %>%
  mutate(further_north = case_when(any(further_north %in% c('bad')) ~ 'bad',
                                   any(further_north %in% c('north')) ~ 'north')) %>%
  ungroup() %>%
  distinct()



```


```{r}
species_select <- 'Girella nigricans'

species_reads <- mifish_edna %>%
  filter(found_taxa == species_select) %>%
  mutate(in_nextseq = case_when(sample_id %in% nextseq_samples$sample_id & method == "miseq" ~ "yes",
                                method == 'nextseq' ~ 'yes')) %>%
  filter(!is.na(in_nextseq)) %>%
  select(sample_id, common_name, found_taxa, asv, motu, reads_raw) %>%
  distinct() 


species_reads %>%
  filter(str_detect(sample_id, 'nextseq')) %>%
  mutate(sample_id = str_remove_all(sample_id, "_nextseq")) %>%
  group_by(sample_id) %>%
  mutate(reads_total = sum(reads_raw)) %>%
  ungroup() %>%
  select(sample_id, reads_total) %>%
  left_join(index_numbers) %>%
  ggplot() +
  geom_point(aes(x = index1_number,
                 y = index2_number,
                 color = reads_total)) +
  scale_color_viridis_c(direction = -1,
                        end = .93,
                        option = 'viridis',
                        label = scales::comma,
                        name = 'Reads') +
  scale_x_continuous(breaks = c(1:23)) +
  scale_y_continuous(breaks = c(1:16)) +
  expand_limits(x = c(1,23),
                y = c(1,16)) +
  labs(x = "Index 1", y = "Index 2",
       title = paste0('Nextseq: ', species_select, ', ', species_reads$common_name[1])) +
  theme_bw() +
  theme(#legend.position = 'none',
        axis.text.x = element_text(angle = 45, hjust = 1),
        panel.grid.minor = element_blank())

ggsave(here(plot_out, paste0(datefield, 'reads-by-index_nextseq_', species_select, '.png')),
       width = 2500, height = 1250, units = 'px')

# for plot
ggsave(here(plot_out, paste0(datefield, 'reads-by-index_nextseq_', species_select, '.pdf')),
       width = 2500, height = 1250, units = 'px')

species_reads %>%
  filter(!(str_detect(sample_id, 'nextseq'))) %>%
  group_by(sample_id) %>%
  mutate(reads_total = sum(reads_raw)) %>%
  ungroup() %>%
  select(sample_id, reads_total) %>%
  left_join(index_numbers) %>%
  ggplot() +
  geom_point(aes(x = index1_number,
                 y = index2_number,
                 color = reads_total)) +
  scale_color_viridis_c(direction = -1,
                        end = .93,
                        option = 'viridis',
                        label = scales::comma,
                        name = 'Reads') +
  scale_x_continuous(breaks = c(1:23)) +
  scale_y_continuous(breaks = c(1:16)) +
    expand_limits(x = c(1,23),
                y = c(1,16)) +
  labs(x = "Index 1", y = "Index 2",
       title = paste0('Miseq: ', species_select, ', ', species_reads$common_name[1])) +
  theme_bw() +
  theme(#legend.position = 'none',
        axis.text.x = element_text(angle = 45, hjust = 1),
        panel.grid.minor = element_blank())

ggsave(here(plot_out, paste0(datefield, 'reads-by-index_miseq_', species_select, '.png')),
       width = 2500, height = 1250, units = 'px')

# for plot
ggsave(here(plot_out, paste0(datefield, 'reads-by-index_miseq_', species_select, '.pdf')),
       width = 2500, height = 1250, units = 'px')
```





# percentages

```{r}
nextseq_index_data <- edna_compare_data %>%
  filter(method == 'nextseq') %>%
  select(sample_id, index, index2, region_label) %>%
  distinct()

# How many combinations can we make with these indices
combinations <- length(unique(nextseq_index_data$index)) * length(unique(nextseq_index_data$index2))

# how many did we make
combos_used <- length(unique(nextseq_index_data$sample_id))

combos_used / combinations

demultiplex_rates <- demulitplex_stats %>%
  filter(!sample_id == 'undetermined') %>%
  select(!c(lane, number_two_mismatch_index_reads, percent_two_mismatch_index_reads))

mean(demultiplex_rates$percent_one_mismatch_index_reads)

# 4% assignable reads had one mismatch
rate_mismatch1 <- sum(demultiplex_rates$number_one_mismatch_index_reads) / sum(demultiplex_rates$number_perfect_index_reads)
# thats 3,433,292 reads
sum(demultiplex_rates$number_one_mismatch_index_reads)

# assuming 1/2 rate of one mismatch that's ~1,716,646 reads in "perfect match"
sum(demultiplex_rates$number_perfect_index_reads) * (rate_mismatch1/2)

# however not all samples had even numbers of mismatch, which is interesting to me
estimated_tagjumping <- demultiplex_rates %>%
  # column that weights odds of tag jumping by sample
  # Again we'll assume the rate is 1/2 of one mismatch
  mutate(percent_2mismatch = percent_one_mismatch_index_reads/2) %>%
  mutate(estimated_2mismatch = number_perfect_index_reads * percent_2mismatch) %>%
  mutate(new_perfectreads = number_perfect_index_reads - estimated_2mismatch)
```

